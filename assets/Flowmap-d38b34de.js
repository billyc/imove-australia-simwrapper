import{i as X,r as ae,g as ct,e as vt,R as re,M as nn,d as on,n as sn}from"./index-6ca30cbc.js";import{c as an}from"./turf.es-748c95cf.js";import{V as rn}from"./VizConfigurator-c3e1aaf2.js";import{Z as cn}from"./ZoomButtons-88e704ed.js";import{W as ln,D as un,S as fn}from"./set-rtl-text-plugin-b53dbe89.js";import{G}from"./index-a3e39363.js";import{a as Yt,p as Zt,b as Vt,M as Wt,G as Kt,D as dn}from"./layer-312e45a6.js";import{r as Te,A as xt}from"./round-6ee9f28e.js";import{s as gn,b as hn,e as pn,f as mn,g as vn,h as yn,i as wn,m as bn,j as Ln,k as Cn,p as xn,l as Fn,n as Sn,o as _n,q as En,r as On,t as In,u as Tn,v as Mn,w as Dn,x as An,y as Pn}from"./ColorsAndWidths-599a36fb.js";import{c as zn,w as Rn}from"./rainbow-4aaba411.js";import{c as Me,e as kn,h as qt,r as Nn,j as Bn,k as De,m as jn,n as Mt}from"./cubehelix-004858ee.js";import{s as Gn,p as $n,a as Un,l as Hn,t as at,b as R,c as Yn,d as Zn,e as Vn,f as Wn,g as Kn,h as qn,i as Xn}from"./sequential-67a491e8.js";import{r as Jn,H as Qn}from"./HTTPFileSystem-a263b5e7.js";import{m as Ae}from"./min-7292b72b.js";import{r as Pe}from"./group-f6e6d4c5.js";import{e as Dt}from"./extent-4cf1c809.js";import{C as to,S as eo,T as no}from"./text-layer-9c1ec202.js";import{D as ce}from"./DashboardDataManager-c48e5039.js";import{y as le}from"./index-650b7cb7.js";import{u as oo}from"./util-6eb30833.js";import"./DataFetcher.worker-c87933e8.js";import"./index-992ee35a.js";import"./LegendBox-f090f8c6.js";import"./extends-98964cd2.js";import"./threshold-7563a86b.js";import"./index-f6506551.js";import"./RoadNetworkLoader.worker-48aaa0eb.js";import"./fxp-26b9b10f.js";var Xt={exports:{}};Xt.exports;(function(n){(function(e,t,o){function i(s){var c=this,f=r();c.next=function(){var u=2091639*c.s0+c.c*23283064365386963e-26;return c.s0=c.s1,c.s1=c.s2,c.s2=u-(c.c=u|0)},c.c=1,c.s0=f(" "),c.s1=f(" "),c.s2=f(" "),c.s0-=f(s),c.s0<0&&(c.s0+=1),c.s1-=f(s),c.s1<0&&(c.s1+=1),c.s2-=f(s),c.s2<0&&(c.s2+=1),f=null}function a(s,c){return c.c=s.c,c.s0=s.s0,c.s1=s.s1,c.s2=s.s2,c}function l(s,c){var f=new i(s),u=c&&c.state,d=f.next;return d.int32=function(){return f.next()*4294967296|0},d.double=function(){return d()+(d()*2097152|0)*11102230246251565e-32},d.quick=d,u&&(typeof u=="object"&&a(u,f),d.state=function(){return a(f,{})}),d}function r(){var s=4022871197,c=function(f){f=String(f);for(var u=0;u<f.length;u++){s+=f.charCodeAt(u);var d=.02519603282416938*s;s=d>>>0,d-=s,d*=s,s=d>>>0,d-=s,s+=d*4294967296}return(s>>>0)*23283064365386963e-26};return c}t&&t.exports?t.exports=l:o&&o.amd?o(function(){return l}):this.alea=l})(X,n,!1)})(Xt);var io=Xt.exports,Jt={exports:{}};Jt.exports;(function(n){(function(e,t,o){function i(r){var s=this,c="";s.x=0,s.y=0,s.z=0,s.w=0,s.next=function(){var u=s.x^s.x<<11;return s.x=s.y,s.y=s.z,s.z=s.w,s.w^=s.w>>>19^u^u>>>8},r===(r|0)?s.x=r:c+=r;for(var f=0;f<c.length+64;f++)s.x^=c.charCodeAt(f)|0,s.next()}function a(r,s){return s.x=r.x,s.y=r.y,s.z=r.z,s.w=r.w,s}function l(r,s){var c=new i(r),f=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,g=(c.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=c.next,u.quick=u,f&&(typeof f=="object"&&a(f,c),u.state=function(){return a(c,{})}),u}t&&t.exports?t.exports=l:o&&o.amd?o(function(){return l}):this.xor128=l})(X,n,!1)})(Jt);var so=Jt.exports,Qt={exports:{}};Qt.exports;(function(n){(function(e,t,o){function i(r){var s=this,c="";s.next=function(){var u=s.x^s.x>>>2;return s.x=s.y,s.y=s.z,s.z=s.w,s.w=s.v,(s.d=s.d+362437|0)+(s.v=s.v^s.v<<4^(u^u<<1))|0},s.x=0,s.y=0,s.z=0,s.w=0,s.v=0,r===(r|0)?s.x=r:c+=r;for(var f=0;f<c.length+64;f++)s.x^=c.charCodeAt(f)|0,f==c.length&&(s.d=s.x<<10^s.x>>>4),s.next()}function a(r,s){return s.x=r.x,s.y=r.y,s.z=r.z,s.w=r.w,s.v=r.v,s.d=r.d,s}function l(r,s){var c=new i(r),f=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,g=(c.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=c.next,u.quick=u,f&&(typeof f=="object"&&a(f,c),u.state=function(){return a(c,{})}),u}t&&t.exports?t.exports=l:o&&o.amd?o(function(){return l}):this.xorwow=l})(X,n,!1)})(Qt);var ao=Qt.exports,te={exports:{}};te.exports;(function(n){(function(e,t,o){function i(r){var s=this;s.next=function(){var f=s.x,u=s.i,d,g;return d=f[u],d^=d>>>7,g=d^d<<24,d=f[u+1&7],g^=d^d>>>10,d=f[u+3&7],g^=d^d>>>3,d=f[u+4&7],g^=d^d<<7,d=f[u+7&7],d=d^d<<13,g^=d^d<<9,f[u]=g,s.i=u+1&7,g};function c(f,u){var d,g=[];if(u===(u|0))g[0]=u;else for(u=""+u,d=0;d<u.length;++d)g[d&7]=g[d&7]<<15^u.charCodeAt(d)+g[d+1&7]<<13;for(;g.length<8;)g.push(0);for(d=0;d<8&&g[d]===0;++d);for(d==8?g[7]=-1:g[d],f.x=g,f.i=0,d=256;d>0;--d)f.next()}c(s,r)}function a(r,s){return s.x=r.x.slice(),s.i=r.i,s}function l(r,s){r==null&&(r=+new Date);var c=new i(r),f=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,g=(c.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=c.next,u.quick=u,f&&(f.x&&a(f,c),u.state=function(){return a(c,{})}),u}t&&t.exports?t.exports=l:o&&o.amd?o(function(){return l}):this.xorshift7=l})(X,n,!1)})(te);var ro=te.exports,ee={exports:{}};ee.exports;(function(n){(function(e,t,o){function i(r){var s=this;s.next=function(){var f=s.w,u=s.X,d=s.i,g,h;return s.w=f=f+1640531527|0,h=u[d+34&127],g=u[d=d+1&127],h^=h<<13,g^=g<<17,h^=h>>>15,g^=g>>>12,h=u[d]=h^g,s.i=d,h+(f^f>>>16)|0};function c(f,u){var d,g,h,p,v,L=[],I=128;for(u===(u|0)?(g=u,u=null):(u=u+"\0",g=0,I=Math.max(I,u.length)),h=0,p=-32;p<I;++p)u&&(g^=u.charCodeAt((p+32)%u.length)),p===0&&(v=g),g^=g<<10,g^=g>>>15,g^=g<<4,g^=g>>>13,p>=0&&(v=v+1640531527|0,d=L[p&127]^=g+v,h=d==0?h+1:0);for(h>=128&&(L[(u&&u.length||0)&127]=-1),h=127,p=4*128;p>0;--p)g=L[h+34&127],d=L[h=h+1&127],g^=g<<13,d^=d<<17,g^=g>>>15,d^=d>>>12,L[h]=g^d;f.w=v,f.X=L,f.i=h}c(s,r)}function a(r,s){return s.i=r.i,s.w=r.w,s.X=r.X.slice(),s}function l(r,s){r==null&&(r=+new Date);var c=new i(r),f=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,g=(c.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=c.next,u.quick=u,f&&(f.X&&a(f,c),u.state=function(){return a(c,{})}),u}t&&t.exports?t.exports=l:o&&o.amd?o(function(){return l}):this.xor4096=l})(X,n,!1)})(ee);var co=ee.exports,ne={exports:{}};ne.exports;(function(n){(function(e,t,o){function i(r){var s=this,c="";s.next=function(){var u=s.b,d=s.c,g=s.d,h=s.a;return u=u<<25^u>>>7^d,d=d-g|0,g=g<<24^g>>>8^h,h=h-u|0,s.b=u=u<<20^u>>>12^d,s.c=d=d-g|0,s.d=g<<16^d>>>16^h,s.a=h-u|0},s.a=0,s.b=0,s.c=-1640531527,s.d=1367130551,r===Math.floor(r)?(s.a=r/4294967296|0,s.b=r|0):c+=r;for(var f=0;f<c.length+20;f++)s.b^=c.charCodeAt(f)|0,s.next()}function a(r,s){return s.a=r.a,s.b=r.b,s.c=r.c,s.d=r.d,s}function l(r,s){var c=new i(r),f=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,g=(c.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=c.next,u.quick=u,f&&(typeof f=="object"&&a(f,c),u.state=function(){return a(c,{})}),u}t&&t.exports?t.exports=l:o&&o.amd?o(function(){return l}):this.tychei=l})(X,n,!1)})(ne);var lo=ne.exports,ze={exports:{}};(function(n){(function(e,t,o){var i=256,a=6,l=52,r="random",s=o.pow(i,a),c=o.pow(2,l),f=c*2,u=i-1,d;function g(y,b,S){var m=[];b=b==!0?{entropy:!0}:b||{};var C=L(v(b.entropy?[y,A(t)]:y??I(),3),m),E=new h(m),M=function(){for(var F=E.g(a),P=s,z=0;F<c;)F=(F+z)*i,P*=i,z=E.g(1);for(;F>=f;)F/=2,P/=2,z>>>=1;return(F+z)/P};return M.int32=function(){return E.g(4)|0},M.quick=function(){return E.g(4)/4294967296},M.double=M,L(A(E.S),t),(b.pass||S||function(F,P,z,N){return N&&(N.S&&p(N,E),F.state=function(){return p(E,{})}),z?(o[r]=F,P):F})(M,C,"global"in b?b.global:this==o,b.state)}function h(y){var b,S=y.length,m=this,C=0,E=m.i=m.j=0,M=m.S=[];for(S||(y=[S++]);C<i;)M[C]=C++;for(C=0;C<i;C++)M[C]=M[E=u&E+y[C%S]+(b=M[C])],M[E]=b;(m.g=function(F){for(var P,z=0,N=m.i,x=m.j,_=m.S;F--;)P=_[N=u&N+1],z=z*i+_[u&(_[N]=_[x=u&x+P])+(_[x]=P)];return m.i=N,m.j=x,z})(i)}function p(y,b){return b.i=y.i,b.j=y.j,b.S=y.S.slice(),b}function v(y,b){var S=[],m=typeof y,C;if(b&&m=="object")for(C in y)try{S.push(v(y[C],b-1))}catch{}return S.length?S:m=="string"?y:y+"\0"}function L(y,b){for(var S=y+"",m,C=0;C<S.length;)b[u&C]=u&(m^=b[u&C]*19)+S.charCodeAt(C++);return A(b)}function I(){try{var y;return d&&(y=d.randomBytes)?y=y(i):(y=new Uint8Array(i),(e.crypto||e.msCrypto).getRandomValues(y)),A(y)}catch{var b=e.navigator,S=b&&b.plugins;return[+new Date,e,S,e.screen,A(t)]}}function A(y){return String.fromCharCode.apply(0,y)}if(L(o.random(),t),n.exports){n.exports=g;try{d=Jn}catch{}}else o["seed"+r]=g})(typeof self<"u"?self:X,[],Math)})(ze);var uo=ze.exports,fo=io,go=so,ho=ao,po=ro,mo=co,vo=lo,J=uo;J.alea=fo;J.xor128=go;J.xorwow=ho;J.xorshift7=po;J.xor4096=mo;J.tychei=vo;var yo=J;const wo=`#define SHADER_NAME animated-flow-lines-layer-fragment-shader

precision highp float;

uniform float animationTailLength;

varying vec4 vColor;
varying float sourceToTarget;
varying vec2 uv;
                                   
void main(void) {
  geometry.uv = uv;

  gl_FragColor = vec4(vColor.xyz, vColor.w * smoothstep(1.0 - animationTailLength, 1.0, fract(sourceToTarget)));

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,bo=`#define SHADER_NAME animated-flow-lines-layer-vertex-shader
#define SPEED 0.015
#define NUM_PARTS 5.0

attribute vec3 positions;
attribute vec3 instanceSourcePositions;
attribute vec3 instanceTargetPositions;
attribute vec3 instanceSourcePositions64Low;
attribute vec3 instanceTargetPositions64Low;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;
attribute float instanceWidths;
attribute float instancePickable;
attribute float instanceStaggering;

uniform float opacity;
uniform float currentTime;
uniform float thicknessUnit;
    
varying vec4 vColor;
varying float sourceToTarget;
varying vec2 uv;

// offset vector by strokeWidth pixels
// offset_direction is -1 (left) or 1 (right)
vec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {
  // normalized direction of the line
  vec2 dir_screenspace = normalize(line_clipspace * project_uViewportSize);
  // rotate by 90 degrees
  dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);

  return dir_screenspace * offset_direction * width / 2.0;
}

void main(void) {
  geometry.worldPosition = instanceSourcePositions;
  geometry.worldPositionAlt = instanceTargetPositions;

  // Position
  vec4 source_commonspace;
  vec4 target_commonspace;
  vec4 source = project_position_to_clipspace(instanceSourcePositions, instanceSourcePositions64Low, vec3(0.), source_commonspace);
  vec4 target = project_position_to_clipspace(instanceTargetPositions, instanceTargetPositions64Low, vec3(0.), target_commonspace);

  float widthPixels = instanceWidths * thicknessUnit;
  
  
  // linear interpolation of source & target to pick right coord
  float segmentIndex = positions.x;
  vec4 p = mix(source, target, segmentIndex);
  geometry.position = mix(source_commonspace, target_commonspace, segmentIndex);
  uv = positions.xy;
  geometry.uv = uv;
  if (instancePickable > 0.5) {
    geometry.pickingColor = instancePickingColors;
  }
  
  // extrude
  vec3 offset = vec3(
    getExtrusionOffset(target.xy - source.xy, positions.y, widthPixels),
    0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  gl_Position = p + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Color
  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity) / 255.;
  DECKGL_FILTER_COLOR(vColor, geometry);

  sourceToTarget = positions.x * length(source - target) * NUM_PARTS - currentTime * SPEED + instanceStaggering; 
}
`,Lo=[0,132,193,255],Re=1800,Co=20,ue=Re/Co;class yt extends Yt{constructor(e){super(e)}getShaders(){return super.getShaders({vs:bo,fs:wo,modules:[Zt,Vt],shaderCache:this.context.shaderCache})}initializeState(){this.getAttributeManager().addInstanced({instanceSourcePositions:{size:3,type:G.DOUBLE,transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:G.DOUBLE,transition:!0,accessor:"getTargetPosition"},instanceColors:{size:4,type:G.UNSIGNED_BYTE,transition:!0,accessor:"getColor",defaultValue:[0,0,0,255]},instanceWidths:{size:1,transition:!0,accessor:"getThickness",defaultValue:1},instanceStaggering:{accessor:"getStaggering",size:1,transition:!1},instancePickable:{accessor:"getPickable",size:1,transition:!1}})}getNeedsRedraw(){return!0}updateState({props:e,oldProps:t,changeFlags:o}){var i;if(super.updateState({props:e,oldProps:t,changeFlags:o}),o.extensionsChanged){const{gl:a}=this.context;(i=this.state.model)===null||i===void 0||i.delete(),this.state.model=this._getModel(a),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){const{thicknessUnit:t,animationTailLength:o}=this.props,a=Date.now()/1e3%ue/ue*Re;this.state.model.setUniforms(Object.assign(Object.assign({},e),{thicknessUnit:t*4,animationTailLength:o,currentTime:a})).draw()}_getModel(e){const t=[0,-1,0,0,1,0,1,-1,0,1,1,0];return new Wt(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new Kt({drawMode:G.TRIANGLE_STRIP,attributes:{positions:new Float32Array(t)}}),isInstanced:!0}))}}yt.defaultProps={currentTime:0,animationTailLength:.7,getSourcePosition:{type:"accessor",value:n=>[0,0]},getTargetPosition:{type:"accessor",value:n=>[0,0]},getPickable:{type:"accessor",value:n=>1},getStaggering:{type:"accessor",value:(n,{index:e})=>Math.random()},getColor:{type:"accessor",value:Lo},getThickness:{type:"accessor",value:1},thicknessUnit:15*2,parameters:{depthTest:!1}};const xo=`#define SHADER_NAME flow-line-layer-fragment-shader

precision highp float;

varying vec4 vColor;
varying vec2 uv;

void main(void) {
  if (vColor.a == 0.0) {
    discard;
  }

  geometry.uv = uv;
  gl_FragColor = vColor;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Fo=`#define SHADER_NAME flow-line-layer-vertex-shader

attribute vec3 positions;
attribute vec3 normals;
attribute vec4 instanceColors;
attribute float instanceThickness;    // 0..0.5
attribute vec3 instanceSourcePositions;
attribute vec3 instanceTargetPositions;
attribute vec3 instanceSourcePositions64Low;
attribute vec3 instanceTargetPositions64Low;
attribute vec3 instancePickingColors;
attribute vec2 instanceEndpointOffsets;
attribute float instancePickable;

uniform vec4 outlineColor;
uniform float thicknessUnit;
uniform float gap;
uniform float opacity;

varying vec4 vColor;
varying vec2 uv;

void main(void) {
  geometry.worldPosition = instanceSourcePositions;
  geometry.worldPositionAlt = instanceTargetPositions;
  
  // Position
  vec4 source_commonspace;    
  vec4 target_commonspace;
  vec4 source = project_position_to_clipspace(instanceSourcePositions, instanceSourcePositions64Low, vec3(0.), source_commonspace);
  vec4 target = project_position_to_clipspace(instanceTargetPositions, instanceTargetPositions64Low, vec3(0.), target_commonspace);

  // linear interpolation of source & target to pick right coord
  float sourceOrTarget = positions.x;
  geometry.position = mix(source_commonspace, target_commonspace, sourceOrTarget);
  uv = positions.xy;
  geometry.uv = uv;
  if (instancePickable > 0.5) {
    geometry.pickingColor = instancePickingColors;
  }
  
  // set the clamp limits in pixel size 
  float lengthCommon = length(target_commonspace - source_commonspace);    
  vec2 offsetDistances = project_pixel_size(positions.yz) * thicknessUnit;
  
  vec2 limitedOffsetDistances = clamp(   
    project_pixel_size(positions.yz) * thicknessUnit,
    -lengthCommon*.8, lengthCommon*.8
  );
  float startOffsetCommon = project_pixel_size(instanceEndpointOffsets[0]);
  float endOffsetCommon = project_pixel_size(instanceEndpointOffsets[1]);
  float endpointOffset = mix(
    clamp(startOffsetCommon, 0.0, lengthCommon*.2),
    -clamp(endOffsetCommon, 0.0, lengthCommon*.2),
    positions.x
  );

  vec2 flowlineDir = normalize(target_commonspace.xy - source_commonspace.xy);
  vec2 perpendicularDir = vec2(-flowlineDir.y, flowlineDir.x);
  vec2 normalsCommon = project_pixel_size(normals.xy);
  float gapCommon = project_pixel_size(gap);
  vec3 offsetCommon = vec3(
    flowlineDir * (instanceThickness * limitedOffsetDistances[1] + normalsCommon.y + endpointOffset * 1.05) -
    perpendicularDir * (instanceThickness * limitedOffsetDistances[0] + gapCommon + normalsCommon.x),
    0.0
  );
  
  DECKGL_FILTER_SIZE(offsetCommon, geometry);
  vec4 position_commonspace = mix(source_commonspace, target_commonspace, sourceOrTarget);
  vec4 offset_commonspace = vec4(offsetCommon, 0.0);
  gl_Position = project_common_position_to_clipspace(position_commonspace + offset_commonspace);
      
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  
  vec4 fillColor = vec4(instanceColors.rgb, instanceColors.a * opacity) / 255.;
  vColor = mix(fillColor, vec4(outlineColor.xyz, outlineColor.w * fillColor.w), normals.z);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,So=[0,132,193,255],_o=1,fe=[1,0,0,1,2,-3,1,1,-3,1,0,0,1,1,-3,0,1,0,1,0,0,0,1,0,0,0,0];function Eo(n,e){return[-e,2*n,1,2*n,-n,1,n,-n,1,-e,2*n,1,n,-n,1,n,-n,1,-e,2*n,1,n,-n,1,-e,-n,1]}const Oo=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class tt extends Yt{constructor(e){super(e)}getShaders(){return super.getShaders({vs:Fo,fs:xo,modules:[Zt,Vt],shaderCache:this.context.shaderCache})}initializeState(){const{attributeManager:e}=this.state;e.addInstanced({instanceSourcePositions:{accessor:"getSourcePosition",size:3,transition:!1,type:G.DOUBLE},instanceTargetPositions:{accessor:"getTargetPosition",size:3,transition:!1,type:G.DOUBLE},instanceThickness:{accessor:"getThickness",size:1,transition:!1},instanceEndpointOffsets:{accessor:"getEndpointOffsets",size:2,transition:!1},instanceColors:{accessor:"getColor",size:4,type:G.UNSIGNED_BYTE,transition:!1},instancePickable:{accessor:"getPickable",size:1,transition:!1}})}updateState({props:e,oldProps:t,changeFlags:o}){if(super.updateState({props:e,oldProps:t,changeFlags:o}),o.extensionsChanged){const{gl:i}=this.context;this.state.model&&this.state.model.delete(),this.setState({model:this._getModel(i)}),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){const{gl:t}=this.context,{outlineColor:o,thicknessUnit:i}=this.props;t.lineWidth(1),this.state.model.setUniforms(Object.assign(Object.assign({},e),{outlineColor:o.map(a=>a/255),thicknessUnit:i*2,gap:.5})).draw()}_getModel(e){let t=[],o=[];const{drawOutline:i,outlineThickness:a}=this.props;if(i){t=t.concat(fe);const l=a,r=_o;o=o.concat(Eo(l,r))}return t=t.concat(fe),o=o.concat(Oo),new Wt(e,Object.assign(Object.assign({id:this.props.id},this.getShaders()),{geometry:new Kt({drawMode:G.TRIANGLES,attributes:{positions:new Float32Array(t),normals:new Float32Array(o)}}),isInstanced:!0,shaderCache:this.context.shaderCache}))}}tt.layerName="FlowLinesLayer";tt.defaultProps={getSourcePosition:{type:"accessor",value:n=>[0,0]},getTargetPosition:{type:"accessor",value:n=>[0,0]},getColor:{type:"accessor",value:So},getThickness:{type:"accessor",value:n=>n.count},getPickable:{type:"accessor",value:n=>1},drawOutline:!0,thicknessUnit:12,outlineThickness:1,outlineColor:[255,255,255,255],parameters:{depthTest:!1}};const Io=`#define SHADER_NAME flow-circles-layer-fragment-shader
#define SOFT_OUTLINE 0.05
#define EPS 0.05
precision highp float;

uniform vec4 emptyColor;
uniform float outlineEmptyMix;

varying vec4 vColor;
varying vec2 unitPosition;
varying float unitInRadius;
varying float unitOutRadius;

float when_gt(float x, float y) {
  return max(sign(x - y), 0.0);
}

void main(void) {
  geometry.uv = unitPosition;
  float distToCenter = length(unitPosition);
  if (distToCenter > 1.0) {
    discard;
  }

  // See https://stackoverflow.com/questions/47285778
  vec4 ringColor = mix(
    emptyColor / 255., vColor,
    when_gt(unitInRadius, unitOutRadius)
  );
  vec4 outlineColor = mix(
    mix(vColor, emptyColor / 255., outlineEmptyMix),
    vColor,
    when_gt(unitInRadius, unitOutRadius)
  );
  
  float innerR = min(unitInRadius, unitOutRadius) * (1.0 - SOFT_OUTLINE);
  
  // Inner circle
  float step2 = innerR - 2.0 * EPS; 
  float step3 = innerR - EPS;
  
  // Ring
  float step4 = innerR;
  // float step5 = 1.0 - SOFT_OUTLINE - EPS;
  // float step6 = 1.0 - SOFT_OUTLINE;
  float step5 = 1.0 - 5.0 * EPS;
  float step6 = 1.0;
  
  gl_FragColor = vColor;
  gl_FragColor = mix(gl_FragColor, emptyColor / 255., smoothstep(step2, step3, distToCenter));
  gl_FragColor = mix(gl_FragColor, ringColor, smoothstep(step3, step4, distToCenter));
  gl_FragColor = mix(gl_FragColor, outlineColor, smoothstep(step5, step6, distToCenter));
  // gl_FragColor = mix(gl_FragColor, emptyColor / 255., smoothstep(step6, 1.0, distToCenter));
  gl_FragColor.a = vColor.a;
  gl_FragColor.a *= smoothstep(0.0, SOFT_OUTLINE, 1.0 - distToCenter);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,To=`#define SHADER_NAME flow-circles-layer-vertex-shader
#define radiusScale 100

attribute vec3 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceInRadius;
attribute float instanceOutRadius;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;

uniform float opacity;
uniform vec4 emptyColor;
uniform float outlineEmptyMix;

varying vec4 vColor;
varying vec2 unitPosition;
varying float unitInRadius;
varying float unitOutRadius;

void main(void) {
  geometry.worldPosition = instancePositions;

  float outerRadiusPixels = max(instanceInRadius, instanceOutRadius);
  unitInRadius = instanceInRadius / outerRadiusPixels; 
  unitOutRadius = instanceOutRadius / outerRadiusPixels; 

  // position on the containing square in [-1, 1] space
  unitPosition = positions.xy;
  geometry.uv = unitPosition;
  geometry.pickingColor = instancePickingColors;
                                                                                                    
  // Find the center of the point and add the current vertex
  vec3 offset = positions * project_pixel_size(outerRadiusPixels);
  DECKGL_FILTER_SIZE(offset, geometry);
  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
                            
  // Apply opacity to instance color, or return instance picking color
  vColor = vec4(instanceColors.rgb / 255., instanceColors.a / 255. * opacity);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,ke=[0,0,0,255],Mo=[255,255,255,255],Do=.4;class ut extends Yt{constructor(e){super(e)}getShaders(){return super.getShaders({vs:To,fs:Io,modules:[Zt,Vt]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:G.DOUBLE,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceInRadius:{size:1,transition:!0,accessor:"getInRadius",defaultValue:1},instanceOutRadius:{size:1,transition:!0,accessor:"getOutRadius",defaultValue:1},instanceColors:{size:4,transition:!0,type:G.UNSIGNED_BYTE,accessor:"getColor",defaultValue:ke}})}updateState({props:e,oldProps:t,changeFlags:o}){if(super.updateState({props:e,oldProps:t,changeFlags:o}),o.extensionsChanged){const{gl:i}=this.context;this.state.model&&this.state.model.delete(),this.setState({model:this._getModel(i)}),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){const{emptyColor:t,outlineEmptyMix:o}=this.props;this.state.model.setUniforms(Object.assign(Object.assign({},e),{emptyColor:t,outlineEmptyMix:o})).draw()}_getModel(e){const t=[-1,-1,0,1,-1,0,1,1,0,-1,1,0];return new Wt(e,Object.assign(this.getShaders(),{id:this.props.id,geometry:new Kt({drawMode:G.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:3,value:new Float32Array(t)}}}),isInstanced:!0}))}}ut.layerName="FlowCirclesLayer";ut.defaultProps={getColor:{type:"accessor",value:ke},emptyColor:{type:"accessor",value:Mo},outlineEmptyMix:{type:"accessor",value:Do},getPosition:{type:"accessor",value:n=>n.position},getInRadius:{type:"accessor",value:1},getOutRadius:{type:"accessor",value:1},parameters:{depthTest:!1}};function oe(n){const{children:e}=n;return e&&e.length>0}function lt(n){const{zoom:e}=n;return e!==void 0}function Ft(n){return n&&!!n.aggregate}var et;(function(n){n.ALL="ALL",n.INCOMING="INCOMING",n.OUTGOING="OUTGOING",n.BETWEEN="BETWEEN"})(et||(et={}));const Ao="#fff",Po=.4,ie="rgba(240,240,240,0.5)",zo=[ie,"#137CBD"],Ro="rgba(220,220,220,0.5)",ko=[ie,"#f6654e"],No=[ie,"#00a9cc"],Bo=[255,255,255,255];function jo(n){return Math.round(n*255)}function de(n,e){const t=Me(n);if(!t)return console.warn("Invalid color: ",n),`rgba(255, 255, 255, ${e})`;const o=t.rgb();return`rgba(${o.r}, ${o.g}, ${o.b}, ${e})`}function U(n){if(Array.isArray(n))return n;const e=Me(n);if(!e)return console.warn("Invalid color: ",n),Bo;const t=e.rgb();return[Math.floor(t.r),Math.floor(t.g),Math.floor(t.b),jo(e.opacity)]}function $(n,e){return n?U(n):typeof e=="string"?U(e):e}const D=n=>n[n.length-1];var At;(function(n){n.primary="#162d3c"})(At||(At={}));const ge=20,Q=n=>Te(0,ge+1).map(e=>n(e/ge)).reverse(),Pt="rgba(240,240,240,0.5)",Go=[Pt,At.primary],$o=["#f7feae","#b7e6a5","#7ccba2","#46aea0","#089099","#00718b","#045275"],Uo=["#d3f2a3","#97e196","#6cc08b","#4c9b82","#217a79","#105965","#074050"],Ne=["#d1eeea","#a8dbd9","#85c4c9","#68abb8","#4f90a6","#3b738f","#2a5674"],Ho=Ne,Yo={Blues:D(gn),BluGrn:["#c4e6c3","#96d2a4","#6dbc90","#4da284","#36877a","#266b6e","#1d4f60"],BluYl:$o,BrwnYl:["#ede5cf","#e0c2a2","#d39c83","#c1766f","#a65461","#813753","#541f3f"],BuGn:D(hn),BuPu:D(pn),Burg:["#ffc6c4","#f4a3a8","#e38191","#cc607d","#ad466c","#8b3058","#672044"],BurgYl:["#fbe6c5","#f5ba98","#ee8a82","#dc7176","#c8586c","#9c3f5d","#70284a"],Cool:Q(zn),DarkMint:["#d2fbd4","#a5dbc2","#7bbcb0","#559c9e","#3a7c89","#235d72","#123f5a"],Emrld:Uo,GnBu:D(mn),Grayish:Go,Greens:D(vn),Greys:D(yn),Inferno:Q(wn),Magenta:["#f3cbd3","#eaa9bd","#dd88ac","#ca699d","#b14d8e","#91357d","#6c2167"],Magma:Q(bn),Mint:["#e4f1e1","#b4d9cc","#89c0b6","#63a6a0","#448c8a","#287274","#0d585f"],Oranges:D(Ln),OrRd:D(Cn),OrYel:["#ecda9a","#efc47e","#f3ad6a","#f7945d","#f97b57","#f66356","#ee4d5a"],Peach:["#fde0c5","#facba6","#f8b58b","#f59e72","#f2855d","#ef6a4c","#eb4a40"],Plasma:Q(xn),PinkYl:["#fef6b5","#ffdd9a","#ffc285","#ffa679","#fa8a76","#f16d7a","#e15383"],PuBu:D(Fn),PuBuGn:D(Sn),PuRd:D(_n),Purp:["#f3e0f7","#e4c7f1","#d1afe8","#b998dd","#9f82ce","#826dba","#63589f"],Purples:D(En),PurpOr:["#f9ddda","#f2b9c4","#e597b9","#ce78b3","#ad5fad","#834ba0","#573b88"],RdPu:D(On),RedOr:["#f6d2a9","#f5b78e","#f19c7c","#ea8171","#dd686c","#ca5268","#b13f64"],Reds:D(In),Sunset:["#f3e79b","#fac484","#f8a07e","#eb7f86","#ce6693","#a059a0","#5c53a5"],SunsetDark:["#fcde9c","#faa476","#f0746e","#e34f6f","#dc3977","#b9257a","#7c1d6f"],Teal:Ne,TealGrn:["#b0f2bc","#89e8ac","#67dba5","#4cc8a3","#38b2a3","#2c98a0","#257d98"],Viridis:Q(Tn),Warm:Q(Rn),YlGn:D(Mn),YlGnBu:D(Dn),YlOrBr:D(An),YlOrRd:D(Pn)},Zo="#f52020",Vo="#17a5be",Wo={negative:{flows:{scheme:[Pt,Vo]}},positive:{flows:{scheme:[Pt,Zo]}},locationAreas:{outline:"rgba(92,112,128,0.5)",normal:"rgba(220,220,220,0.5)"},outlineColor:"rgb(230,233,237)"};function Ko(n){return Be(!1,n.colorScheme,n.darkMode,n.fadeEnabled,n.fadeOpacityEnabled,n.fadeAmount,n.animationEnabled)}function Be(n,e,t,o,i,a,l){if(n)return Wo;let r;Array.isArray(e)?r=e:(r=e&&Yo[e]||Ho,t&&(r=r.slice().reverse()));{const s=Te(0,Math.max(10,r.length)),c=s.length-1,f=Gn(kn(r)).domain([0,c]);if(!o||a===0)r=s.map((u,d)=>f(d));else{const u=$n().exponent(1.5).domain([c,0]).range([0,2*a/100]);r=s.map((d,g)=>{const h=f(g),p=u(g);if(h==null||p==null)return"#000";const v=qt(h);return v.l=t?v.l-v.l*p:v.l+(100-v.l)*p,v.c=v.c-v.c*(p/4),i&&(v.opacity=v.opacity*(1-p)),v.toString()})}}return{darkMode:t,flows:{scheme:r},locationCircles:{outgoing:t?"#000":"#fff"},outlineColor:t?"#000":"rgba(255, 255, 255, 0.5)"}}function qo(n){const e=Bn,t=n.length;let o=new Array(t),i=new Array(t),a=new Array(t),l=new Array(t),r,s;for(r=0;r<t;++r)s=Nn(n[r]),o[r]=s.r||0,i[r]=s.g||0,a[r]=s.b||0,l[r]=s.opacity||0;return o=e(o),i=e(i),a=e(a),l=e(l),function(c){return s.r=o(c),s.g=i(c),s.b=a(c),s.opacity=l(c),s+""}}function St(n,e,t){const o=Un(qo(e)).exponent(t?.5:.3333333333333333).domain(n);return i=>U(o(i))}function Xo(n,e,t){const o=e?e[0]:0,i=e?e[1]:0;if(je(n)){const l=St([0,i],n.positive.flows.scheme,t),r=St([0,o],n.negative.flows.scheme,t);return s=>s>=0?l(s):r(s)}const a=St([0,i||0],n.flows.scheme,t);return l=>a(l)}function Jo(n){return n.positive!==void 0}function je(n){return n.positive!==void 0}function Qo(n,e){const t=n&&n.normal||Ro,o=qt(t),i=U(t);return{normal:i,connected:$(n&&n.connected,i),highlighted:$(n&&n.highlighted,de(o[e?"brighter":"darker"](1).toString(),.5)),selected:$(n&&n.selected,de(o[e?"brighter":"darker"](2).toString(),.8)),outline:$(n&&n.outline,U(o[e?"brighter":"darker"](4).toString()))}}function zt(n,e,t){var o,i,a;const l=n&&n.flows&&n.flows.scheme||e,r=qt(l[l.length-1]),s=$(n&&n.flows&&n.flows.highlighted,U(r[t?"brighter":"darker"](.7).toString())),c=$((o=n==null?void 0:n.locationCircles)===null||o===void 0?void 0:o.empty,t?"#000":"#fff"),f=$(n&&n.locationCircles&&n.locationCircles.inner,r.toString());return{flows:{scheme:l,highlighted:s},locationCircles:{inner:f,outgoing:$(n&&n.locationCircles&&n.locationCircles.outgoing,t?"#000":"#fff"),incoming:$(n&&n.locationCircles&&n.locationCircles.incoming,r[t?"brighter":"darker"](1.25).toString()),highlighted:$(n&&n.locationCircles&&n.locationCircles.highlighted,s),empty:c,outlineEmptyMix:(a=(i=n==null?void 0:n.locationCircles)===null||i===void 0?void 0:i.outlineEmptyMix)!==null&&a!==void 0?a:.4}}}function Ge(n){const e=!!(n&&n.darkMode);return{darkMode:e,locationAreas:Qo(n&&n.locationAreas,e),outlineColor:U(n&&n.outlineColor||Ao),dimmedOpacity:n&&n.dimmedOpacity!=null?n.dimmedOpacity:Po}}function ti(n){const e=Ge(n);return Object.assign(Object.assign({},e),zt(n,zo,e.darkMode))}function ei(n){const e=Ge(n);return Object.assign(Object.assign({},e),{positive:zt(n&&n.positive,ko,e.darkMode),negative:zt(n&&n.negative,No,e.darkMode)})}function Rt(n,e,t,o,i,a){if(i-o<=t)return;const l=o+i>>1;$e(n,e,l,o,i,a%2),Rt(n,e,t,o,l-1,a+1),Rt(n,e,t,l+1,i,a+1)}function $e(n,e,t,o,i,a){for(;i>o;){if(i-o>600){const c=i-o+1,f=t-o+1,u=Math.log(c),d=.5*Math.exp(2*u/3),g=.5*Math.sqrt(u*d*(c-d)/c)*(f-c/2<0?-1:1),h=Math.max(o,Math.floor(t-f*d/c+g)),p=Math.min(i,Math.floor(t+(c-f)*d/c+g));$e(n,e,t,h,p,a)}const l=e[2*t+a];let r=o,s=i;for(rt(n,e,o,t),e[2*i+a]>l&&rt(n,e,o,i);r<s;){for(rt(n,e,r,s),r++,s--;e[2*r+a]<l;)r++;for(;e[2*s+a]>l;)s--}e[2*o+a]===l?rt(n,e,o,s):(s++,rt(n,e,s,i)),s<=t&&(o=s+1),t<=s&&(i=s-1)}}function rt(n,e,t,o){_t(n,t,o),_t(e,2*t,2*o),_t(e,2*t+1,2*o+1)}function _t(n,e,t){const o=n[e];n[e]=n[t],n[t]=o}function ni(n,e,t,o,i,a,l){const r=[0,n.length-1,0],s=[];let c,f;for(;r.length;){const u=r.pop(),d=r.pop(),g=r.pop();if(d-g<=l){for(let v=g;v<=d;v++)c=e[2*v],f=e[2*v+1],c>=t&&c<=i&&f>=o&&f<=a&&s.push(n[v]);continue}const h=Math.floor((g+d)/2);c=e[2*h],f=e[2*h+1],c>=t&&c<=i&&f>=o&&f<=a&&s.push(n[h]);const p=(u+1)%2;(u===0?t<=c:o<=f)&&(r.push(g),r.push(h-1),r.push(p)),(u===0?i>=c:a>=f)&&(r.push(h+1),r.push(d),r.push(p))}return s}function oi(n,e,t,o,i,a){const l=[0,n.length-1,0],r=[],s=i*i;for(;l.length;){const c=l.pop(),f=l.pop(),u=l.pop();if(f-u<=a){for(let v=u;v<=f;v++)he(e[2*v],e[2*v+1],t,o)<=s&&r.push(n[v]);continue}const d=Math.floor((u+f)/2),g=e[2*d],h=e[2*d+1];he(g,h,t,o)<=s&&r.push(n[d]);const p=(c+1)%2;(c===0?t-i<=g:o-i<=h)&&(l.push(u),l.push(d-1),l.push(p)),(c===0?t+i>=g:o+i>=h)&&(l.push(d+1),l.push(f),l.push(p))}return r}function he(n,e,t,o){const i=n-t,a=e-o;return i*i+a*a}const ii=n=>n[0],si=n=>n[1];class kt{constructor(e,t=ii,o=si,i=64,a=Float64Array){this.nodeSize=i,this.points=e;const l=e.length<65536?Uint16Array:Uint32Array,r=this.ids=new l(e.length),s=this.coords=new a(e.length*2);for(let c=0;c<e.length;c++)r[c]=c,s[2*c]=t(e[c]),s[2*c+1]=o(e[c]);Rt(r,s,i,0,r.length-1,0)}range(e,t,o,i){return ni(this.ids,this.coords,e,t,o,i,this.nodeSize)}within(e,t,o){return oi(this.ids,this.coords,e,t,o,this.nodeSize)}}var wt="NOT_FOUND";function ai(n){var e;return{get:function(o){return e&&n(e.key,o)?e.value:wt},put:function(o,i){e={key:o,value:i}},getEntries:function(){return e?[e]:[]},clear:function(){e=void 0}}}function ri(n,e){var t=[];function o(r){var s=t.findIndex(function(f){return e(r,f.key)});if(s>-1){var c=t[s];return s>0&&(t.splice(s,1),t.unshift(c)),c.value}return wt}function i(r,s){o(r)===wt&&(t.unshift({key:r,value:s}),t.length>n&&t.pop())}function a(){return t}function l(){t=[]}return{get:o,put:i,getEntries:a,clear:l}}var ci=function(e,t){return e===t};function li(n){return function(t,o){if(t===null||o===null||t.length!==o.length)return!1;for(var i=t.length,a=0;a<i;a++)if(!n(t[a],o[a]))return!1;return!0}}function Ue(n,e){var t=typeof e=="object"?e:{equalityCheck:e},o=t.equalityCheck,i=o===void 0?ci:o,a=t.maxSize,l=a===void 0?1:a,r=t.resultEqualityCheck,s=li(i),c=l===1?ai(s):ri(l,s);function f(){var u=c.get(arguments);if(u===wt){if(u=n.apply(null,arguments),r){var d=c.getEntries(),g=d.find(function(h){return r(h.value,u)});g&&(u=g.value)}c.put(arguments,u)}return u}return f.clearCache=function(){return c.clear()},f}function ui(n){var e=Array.isArray(n[0])?n[0]:n;if(!e.every(function(o){return typeof o=="function"})){var t=e.map(function(o){return typeof o=="function"?"function "+(o.name||"unnamed")+"()":typeof o}).join(", ");throw new Error("createSelector expects all input-selectors to be functions, but received the following types: ["+t+"]")}return e}function He(n){for(var e=arguments.length,t=new Array(e>1?e-1:0),o=1;o<e;o++)t[o-1]=arguments[o];var i=function(){for(var l=arguments.length,r=new Array(l),s=0;s<l;s++)r[s]=arguments[s];var c=0,f,u={memoizeOptions:void 0},d=r.pop();if(typeof d=="object"&&(u=d,d=r.pop()),typeof d!="function")throw new Error("createSelector expects an output function after the inputs, but received: ["+typeof d+"]");var g=u,h=g.memoizeOptions,p=h===void 0?t:h,v=Array.isArray(p)?p:[p],L=ui(r),I=n.apply(void 0,[function(){return c++,d.apply(null,arguments)}].concat(v)),A=n(function(){for(var b=[],S=L.length,m=0;m<S;m++)b.push(L[m].apply(null,arguments));return f=I.apply(null,b),f});return Object.assign(A,{resultFunc:d,memoizedResultFunc:I,dependencies:L,lastResult:function(){return f},recomputations:function(){return c},resetRecomputations:function(){return c=0}}),A};return i}var w=He(Ue);const fi={minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,makeClusterName:(n,e)=>{},makeClusterId:n=>`{[${n}]}`};function di(n){const{index:e}=n;return e!=null}function Ye(n){const{id:e}=n;return e!=null}function gi(n,e,t,o){const{getLocationLon:i,getLocationLat:a,getLocationId:l}=e,r=Object.assign(Object.assign({},fi),o),{minZoom:s,maxZoom:c,nodeSize:f,makeClusterName:u,makeClusterId:d}=r,g=new Array(c+1);let h=new Array,p=0;for(const m of n){const C=i(m),E=a(m);h.push({x:yi(C),y:wi(E),weight:t(l(m)),zoom:1/0,index:p,parentId:-1,location:m}),p++}g[c+1]=new kt(h,pe,me,f,Float32Array);let v=c+1;for(let m=c;m>=s;m--){const C=pi(h,m,g[v],r);C.length===h.length?(g[m]=g[v],g[v]=void 0,v=m,h=C):(v=m,h=C,g[m]=new kt(h,pe,me,f,Float32Array))}if(g.length===0)return[];const L=g.map(m=>m==null?void 0:m.points.length),I=Ae(L.filter(m=>m>0)),A=bi(n,e);let y=L.indexOf(A);A<p&&(y++,y<c+1&&(g[y]=g[c+1],g[c+1]=void 0));const b=Math.min(y,L.lastIndexOf(I)),S=new Array;v=NaN;for(let m=y;m>=b;m--){let C;const E=g[m];if(!E)continue;m<y&&(C=Pe(g[v].points,F=>F.map(P=>P.id?d(P.id):l(P.location)),F=>F.parentId));const M=[];for(const F of E.points){const{x:P,y:z,numPoints:N,location:x}=F;if(di(F))M.push({id:l(x),zoom:m,lat:a(x),lon:i(x)});else if(Ye(F)){const{id:_}=F,st=C&&C.get(_);if(!st)throw new Error(`Cluster ${_} doesn't have children`);M.push({id:d(_),name:u(_,N),zoom:m,lat:vi(z),lon:mi(P),children:st})}}S.push({zoom:m,nodes:M}),v=m}return S}function hi(n,e,t,o,i){return{x:n,y:e,zoom:1/0,id:t,parentId:-1,numPoints:o,weight:i}}function pi(n,e,t,o){const i=[],{radius:a,extent:l}=o,r=a/(l*Math.pow(2,e));for(let s=0;s<n.length;s++){const c=n[s];if(c.zoom<=e)continue;c.zoom=e;const f=t.within(c.x,c.y,r);let u=c.weight||1,d=Ye(c)?c.numPoints:1,g=c.x*u,h=c.y*u;const p=(s<<5)+(e+1);for(const v of f){const L=t.points[v];if(L.zoom<=e)continue;L.zoom=e;const I=L.weight||1,A=L.numPoints||1;g+=L.x*I,h+=L.y*I,u+=I,d+=A,L.parentId=p}d===1?i.push(c):(c.parentId=p,i.push(hi(g/u,h/u,p,d,u)))}return i}function mi(n){return(n-.5)*360}function vi(n){const e=(180-n*360)*Math.PI/180;return 360*Math.atan(Math.exp(e))/Math.PI-90}function yi(n){return n/360+.5}function wi(n){const e=Math.sin(n*Math.PI/180),t=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return t<0?0:t>1?1:t}function pe(n){return n.x}function me(n){return n.y}function bi(n,e){const{getLocationLon:t,getLocationLat:o}=e,i=new Map;let a=0;for(const r of n){const s=t(r),c=o(r),f=`${s},${c}`,u=i.get(f);i.set(f,u?u+1:1),a++}let l=0;for(const[r,s]of i)s>1&&l++;return a-l}function Li(n){const e=new Map,t=new Map,o=new Map;for(const{zoom:u,nodes:d}of n){e.set(u,d);for(const g of d)if(oe(g))t.set(g.id,g);else{const{id:h}=g,p=o.get(h);(p==null||p>u)&&o.set(h,u)}}const[i,a]=Dt(n,u=>u.zoom);if(i==null||a==null)throw new Error("Could not determine minZoom or maxZoom");const l=new Map;for(const u of t.values()){const{zoom:d}=u;let g=l.get(d);g||(g=new Map,l.set(d,g)),r(u,h=>{g==null||g.set(h,u)})}function r(u,d){for(const g of u.children){const h=t.get(g);h?r(h,d):d(g)}}const s=(u,d=a)=>{const g=[],h=(p,v)=>{if(d>p.zoom)for(const L of p.children){const I=t.get(L);I?h(I,v):v.push(L)}else v.push(p.id)};return h(u,g),g};function c(u,d){const g=l.get(d);if(!g)return;const h=g.get(u);return h?h.id:void 0}return{availableZoomLevels:n.map(u=>+u.zoom).sort((u,d)=>De(u,d)),getClusterNodesFor:u=>{if(u!==void 0)return e.get(u)},getClusterById:u=>t.get(u),getMinZoomForLocation:u=>o.get(u)||i,expandCluster:s,findClusterFor:c,aggregateFlows:(u,d,{getFlowOriginId:g,getFlowDestId:h,getFlowMagnitude:p},v={})=>{if(d>a)return u;const L=[],I=new Map,A=(b,S)=>`${b}:${S}`,{flowCountsMapReduce:y={map:p,reduce:(b,S)=>(b||0)+S}}=v;for(const b of u){const S=g(b),m=h(b),C=c(S,d)||S,E=c(m,d)||m,M=A(C,E);if(C===S&&E===m)L.push(b);else{let F=I.get(M);F?F.count=y.reduce(F.count,y.map(b)):(F={origin:C,dest:E,count:y.map(b),aggregate:!0},L.push(F),I.set(M,F))}}return L}}}function Ci(n,{getFlowOriginId:e,getFlowDestId:t,getFlowMagnitude:o}){const i={incoming:new Map,outgoing:new Map};for(const a of n){const l=e(a),r=t(a),s=o(a);i.incoming.set(r,(i.incoming.get(r)||0)+s),i.outgoing.set(l,(i.outgoing.get(l)||0)+s)}return a=>Math.max(Math.abs(i.incoming.get(a)||0),Math.abs(i.outgoing.get(a)||0))}function xi(n,e){if(!n.length)throw new Error("No available zoom levels");return n[Math.min(jn(n,Math.floor(e)),n.length-1)]}class Nt{constructor(e){this.getLocationId=t=>lt(t)?t.id:this.accessors.getLocationId(t),this.getLocationName=t=>{let o;return lt(t)&&oe(t)?o=t.name:this.accessors.getLocationName&&(o=this.accessors.getLocationName(t)),o||(o=`${this.getLocationId(t)}`),o},this.getLocationLat=t=>lt(t)?t.lat:this.accessors.getLocationLat(t),this.getLocationLon=t=>lt(t)?t.lon:this.accessors.getLocationLon(t),this.getFlowOriginId=t=>Ft(t)?t.origin:this.accessors.getFlowOriginId(t),this.getFlowDestId=t=>Ft(t)?t.dest:this.accessors.getFlowDestId(t),this.getFlowMagnitude=t=>Ft(t)?t.count:this.accessors.getFlowMagnitude(t),this.getFlowTime=t=>{const{getFlowTime:o}=this.accessors;return o?o(t):void 0},this.accessors=e}setAccessors(e){this.accessors=e}getFlowmapDataAccessors(){return this.accessors}}const Fi=(n,e=0)=>{const t=e,o=new ln(Object.assign(Object.assign({},n),{width:n.width+t*2,height:n.height+t*2})).getBounds();return[o[0][0],o[0][1],o[1][0],o[1][1]]},Si=n=>{if(n)return Hn().range([.025,.5]).domain([0,Math.max.apply(null,n.map(e=>Math.abs(e||0)))])};function _i(n,e,t,o,i){const{getLocationId:a,getLocationName:l,getLocationClusterName:r}=o,s=c=>{const f=t.get(c);return f?l?l(f):a(f)||c:`"${c}"`};for(const c of e)for(const f of c.nodes)if(oe(f)){const u=n.expandCluster(f);if(u.sort((d,g)=>Mt(i(d),i(g))),r)f.name=r(u);else{const d=u[0],g=u.length===2?u[1]:void 0;f.name=`"${s(d)}" and ${g?`"${s(g)}"`:`${u.length-1} others`}`}}else f.name=s(f.id)}at("%Y-%m-%d"),at("%Y-%m-%d %H:%M"),at("%Y-%m-%d %H:%M:%S"),at("%Y"),at("%Y-%m");var W;(function(n){n.SECOND="SECOND",n.MINUTE="MINUTE",n.HOUR="HOUR",n.DAY="DAY",n.MONTH="MONTH",n.YEAR="YEAR"})(W||(W={}));R(".%L");const Ei=R(":%S"),Oi=R("%I:%M"),Ii=R("%I %p"),Ti=R("%a %d");R("%b %d");const Mi=R("%b"),Di=R("%Y"),ft=[{order:0,key:W.SECOND,interval:Yn,format:Ei,formatFull:R("%Y-%m-%d %H:%M:%S")},{order:1,key:W.MINUTE,interval:Zn,format:Oi,formatFull:R("%Y-%m-%d %H:%M")},{order:2,key:W.HOUR,interval:Vn,format:Ii,formatFull:R("%a %d %b %Y, %I %p")},{order:3,key:W.DAY,interval:Wn,format:Ti,formatFull:R("%a %d %b %Y")},{order:4,key:W.MONTH,interval:Kn,format:Mi,formatFull:R("%b %Y")},{order:5,key:W.YEAR,interval:qn,format:Di,formatFull:R("%Y")}];function ve(n){return ft.find(e=>e.key===n)}function Ai(n){return ft.find(e=>e.order===n)}function Pi(n){let e;for(const t of ft){const{interval:o}=t;if(o(n)<n)return e||t;e=t}return ft[ft.length-1]}const zi=20;class Ri{constructor(e){this.getFlowsFromProps=(t,o)=>o.flows,this.getLocationsFromProps=(t,o)=>o.locations,this.getClusterLevelsFromProps=(t,o)=>o.clusterLevels,this.getMaxTopFlowsDisplayNum=(t,o)=>t.settings.maxTopFlowsDisplayNum,this.getSelectedLocations=(t,o)=>{var i;return(i=t.filter)===null||i===void 0?void 0:i.selectedLocations},this.getLocationFilterMode=(t,o)=>{var i;return(i=t.filter)===null||i===void 0?void 0:i.locationFilterMode},this.getClusteringEnabled=(t,o)=>t.settings.clusteringEnabled,this.getLocationTotalsEnabled=(t,o)=>t.settings.locationTotalsEnabled,this.getLocationLabelsEnabled=(t,o)=>t.settings.locationLabelsEnabled,this.getZoom=(t,o)=>t.viewport.zoom,this.getViewport=(t,o)=>t.viewport,this.getSelectedTimeRange=(t,o)=>{var i;return(i=t.filter)===null||i===void 0?void 0:i.selectedTimeRange},this.getColorScheme=(t,o)=>t.settings.colorScheme,this.getDarkMode=(t,o)=>t.settings.darkMode,this.getFadeEnabled=(t,o)=>t.settings.fadeEnabled,this.getFadeOpacityEnabled=(t,o)=>t.settings.fadeOpacityEnabled,this.getFadeAmount=(t,o)=>t.settings.fadeAmount,this.getAnimate=(t,o)=>t.settings.animationEnabled,this.getInvalidLocationIds=w(this.getLocationsFromProps,t=>{if(!t)return;const o=[];for(const i of t){const a=this.accessors.getLocationId(i),l=this.accessors.getLocationLon(i),r=this.accessors.getLocationLat(i);(!(-90<=r&&r<=90)||!(-180<=l&&l<=180))&&o.push(a)}return o.length>0?o:void 0}),this.getLocations=w(this.getLocationsFromProps,this.getInvalidLocationIds,(t,o)=>{if(!t)return;if(!o||o.length===0)return t;const i=new Set(o),a=[];for(const l of t){const r=this.accessors.getLocationId(l);i.has(r)||a.push(l)}return a}),this.getLocationIds=w(this.getLocations,t=>{if(!t)return;const o=new Set;for(const i of t)o.add(this.accessors.getLocationId(i));return o}),this.getSelectedLocationsSet=w(this.getSelectedLocations,t=>t&&t.length>0?new Set(t):void 0),this.getSortedFlowsForKnownLocations=w(this.getFlowsFromProps,this.getLocationIds,(t,o)=>{if(!o||!t)return;const i=[];for(const a of t){const l=this.accessors.getFlowOriginId(a),r=this.accessors.getFlowDestId(a);o.has(l)&&o.has(r)&&i.push(a)}return i.sort((a,l)=>Mt(Math.abs(this.accessors.getFlowMagnitude(a)),Math.abs(this.accessors.getFlowMagnitude(l))))}),this.getActualTimeExtent=w(this.getSortedFlowsForKnownLocations,t=>{if(!t)return;let o=null,i=null;for(const a of t){const l=this.accessors.getFlowTime(a);l&&((o==null||o>l)&&(o=l),(i==null||i<l)&&(i=l))}if(!(!o||!i))return[o,i]}),this.getTimeGranularityKey=w(this.getSortedFlowsForKnownLocations,this.getActualTimeExtent,(t,o)=>{if(!t||!o)return;const i=Ae(t,l=>{const r=this.accessors.getFlowTime(l);return r?Pi(r).order:null});if(i==null)return;const a=Ai(i);return a?a.key:void 0}),this.getTimeExtent=w(this.getActualTimeExtent,this.getTimeGranularityKey,(t,o)=>{const i=o?ve(o):void 0;if(!t||!(i!=null&&i.interval))return;const{interval:a}=i;return[t[0],a.offset(a.floor(t[1]),1)]}),this.getSortedFlowsForKnownLocationsFilteredByTime=w(this.getSortedFlowsForKnownLocations,this.getTimeExtent,this.getSelectedTimeRange,(t,o,i)=>{if(t)return!o||!i||o[0]===i[0]&&o[1]===i[1]?t:t.filter(a=>{const l=this.accessors.getFlowTime(a);return l&&i[0]<=l&&l<i[1]})}),this.getLocationsHavingFlows=w(this.getSortedFlowsForKnownLocations,this.getLocations,(t,o)=>{if(!o||!t)return o;const i=new Set;for(const l of t)i.add(this.accessors.getFlowOriginId(l)),i.add(this.accessors.getFlowDestId(l));const a=[];for(const l of o)i.has(this.accessors.getLocationId(l))&&a.push(l);return a}),this.getLocationsById=w(this.getLocationsHavingFlows,t=>{if(!t)return;const o=new Map;for(const i of t)o.set(this.accessors.getLocationId(i),i);return o}),this.getLocationWeightGetter=w(this.getSortedFlowsForKnownLocations,t=>t?Ci(t,this.accessors.getFlowmapDataAccessors()):void 0),this.getClusterLevels=w(this.getClusterLevelsFromProps,this.getLocationsHavingFlows,this.getLocationWeightGetter,(t,o,i)=>t||(!o||!i?void 0:gi(o,this.accessors.getFlowmapDataAccessors(),i,{maxZoom:zi}))),this.getClusterIndex=w(this.getLocationsById,this.getLocationWeightGetter,this.getClusterLevels,(t,o,i)=>{if(!t||!o||!i)return;const a=Li(i);return _i(a,i,t,this.accessors.getFlowmapDataAccessors(),o),a}),this.getAvailableClusterZoomLevels=w(this.getClusterIndex,this.getSelectedLocations,(t,o)=>{if(!t)return;let i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;const l=r=>{const s=t.getClusterById(r);if(s)a=Math.max(a,s.zoom),i=Math.min(i,s.zoom);else{const c=t.getMinZoomForLocation(r);a=Math.max(a,c)}};if(o)for(const r of o)l(r);return t.availableZoomLevels.filter(r=>a<=r&&r<=i)}),this._getClusterZoom=w(this.getClusterIndex,this.getZoom,this.getAvailableClusterZoomLevels,(t,o,i)=>!t||!i||o==null?void 0:xi(i,o)),this.getClusterZoom=(t,o)=>{const{settings:i}=t;if(i.clusteringEnabled)return i.clusteringAuto||i.clusteringLevel==null?this._getClusterZoom(t,o):i.clusteringLevel},this.getLocationsForSearchBox=w(this.getClusteringEnabled,this.getLocationsHavingFlows,this.getSelectedLocations,this.getClusterZoom,this.getClusterIndex,(t,o,i,a,l)=>{if(!o)return;let r=Array.from(o);if(l&&i){const s=[];for(const c of i){const f=l.getClusterById(c);f&&!r.find(u=>(lt(u)?u.id:this.accessors.getLocationId(u))===c)&&s.push(f)}s.length>0&&(r=r.concat(s))}return r}),this.getDiffMode=w(this.getFlowsFromProps,t=>{if(t){for(const o of t)if(this.accessors.getFlowMagnitude(o)<0)return!0}return!1}),this._getFlowmapColors=w(this.getDiffMode,this.getColorScheme,this.getDarkMode,this.getFadeEnabled,this.getFadeOpacityEnabled,this.getFadeAmount,this.getAnimate,Be),this.getFlowmapColorsRGBA=w(this._getFlowmapColors,t=>Jo(t)?ei(t):ti(t)),this.getUnknownLocations=w(this.getLocationIds,this.getFlowsFromProps,this.getSortedFlowsForKnownLocations,(t,o,i)=>{if(!t||!o||i)return;const a=new Set;for(const l of o)t.has(this.accessors.getFlowOriginId(l))||a.add(this.accessors.getFlowOriginId(l)),t.has(this.accessors.getFlowDestId(l))||a.add(this.accessors.getFlowDestId(l));return a}),this.getSortedAggregatedFilteredFlows=w(this.getClusterIndex,this.getClusteringEnabled,this.getSortedFlowsForKnownLocationsFilteredByTime,this.getClusterZoom,this.getTimeExtent,(t,o,i,a,l)=>{if(!i)return;let r;return o&&t&&a!=null?r=t.aggregateFlows(i,a,this.accessors.getFlowmapDataAccessors()):r=ki(i,this.accessors.getFlowmapDataAccessors()),r.sort((s,c)=>Mt(Math.abs(this.accessors.getFlowMagnitude(s)),Math.abs(this.accessors.getFlowMagnitude(c)))),r}),this.getExpandedSelectedLocationsSet=w(this.getClusteringEnabled,this.getSelectedLocationsSet,this.getClusterIndex,(t,o,i)=>{if(!o||!i)return o;const a=new Set;for(const l of o){const r=i.getClusterById(l);if(r){const s=i.expandCluster(r);for(const c of s)a.add(c)}else a.add(l)}return a}),this.getTotalCountsByTime=w(this.getSortedFlowsForKnownLocations,this.getTimeGranularityKey,this.getTimeExtent,this.getExpandedSelectedLocationsSet,this.getLocationFilterMode,(t,o,i,a,l)=>{const r=o?ve(o):void 0;if(!t||!r||!i)return;const s=t.reduce((c,f)=>{var u;if(this.isFlowInSelection(f,a,l)){const d=r.interval(this.accessors.getFlowTime(f)).getTime();c.set(d,((u=c.get(d))!==null&&u!==void 0?u:0)+this.accessors.getFlowMagnitude(f))}return c},new Map);return Array.from(s.entries()).map(([c,f])=>({time:new Date(c),count:f}))}),this.getMaxLocationCircleSize=w(this.getLocationTotalsEnabled,t=>t?17:1),this.getViewportBoundingBox=w(this.getViewport,this.getMaxLocationCircleSize,Fi),this.getLocationsForZoom=w(this.getClusteringEnabled,this.getLocationsHavingFlows,this.getClusterIndex,this.getClusterZoom,(t,o,i,a)=>t&&i?i.getClusterNodesFor(a):o),this.getLocationTotals=w(this.getLocationsForZoom,this.getSortedAggregatedFilteredFlows,this.getSelectedLocationsSet,this.getLocationFilterMode,(t,o,i,a)=>{if(!o)return;const l=new Map,r=(s,c)=>{var f;const u=(f=l.get(s))!==null&&f!==void 0?f:{incomingCount:0,outgoingCount:0,internalCount:0};return c.incomingCount!=null&&(u.incomingCount+=c.incomingCount),c.outgoingCount!=null&&(u.outgoingCount+=c.outgoingCount),c.internalCount!=null&&(u.internalCount+=c.internalCount),u};for(const s of o)if(this.isFlowInSelection(s,i,a)){const c=this.accessors.getFlowOriginId(s),f=this.accessors.getFlowDestId(s),u=this.accessors.getFlowMagnitude(s);c===f?l.set(c,r(c,{internalCount:u})):(l.set(c,r(c,{outgoingCount:u})),l.set(f,r(f,{incomingCount:u})))}return l}),this.getLocationsTree=w(this.getLocationsForZoom,t=>{if(t)return new kt(t,o=>Et(this.accessors.getLocationLon(o)),o=>Ot(this.accessors.getLocationLat(o)))}),this._getLocationIdsInViewport=w(this.getLocationsTree,this.getViewportBoundingBox,(t,o)=>{const i=this._getLocationsInBboxIndices(t,o);if(i)return new Set(i.map(a=>t.points[a].id))}),this.getLocationIdsInViewport=He(Ue,(t,o,i)=>{if(t===o)return!0;if(t==null||o==null||t.size!==o.size)return!1;for(const a of t)if(!o.has(a))return!1;return!0})(this._getLocationIdsInViewport,t=>{if(t)return t}),this.getTotalUnfilteredCount=w(this.getSortedFlowsForKnownLocations,t=>{if(t)return t.reduce((o,i)=>o+this.accessors.getFlowMagnitude(i),0)}),this.getTotalFilteredCount=w(this.getSortedAggregatedFilteredFlows,this.getSelectedLocationsSet,this.getLocationFilterMode,(t,o,i)=>t?t.reduce((l,r)=>this.isFlowInSelection(r,o,i)?l+this.accessors.getFlowMagnitude(r):l,0):void 0),this._getLocationTotalsExtent=w(this.getLocationTotals,t=>ye(t,void 0)),this._getLocationTotalsForViewportExtent=w(this.getLocationTotals,this.getLocationIdsInViewport,(t,o)=>ye(t,o)),this.getLocationTotalsExtent=(t,o)=>t.settings.adaptiveScalesEnabled?this._getLocationTotalsForViewportExtent(t,o):this._getLocationTotalsExtent(t,o),this.getFlowsForFlowmapLayer=w(this.getSortedAggregatedFilteredFlows,this.getLocationIdsInViewport,this.getSelectedLocationsSet,this.getLocationFilterMode,this.getMaxTopFlowsDisplayNum,(t,o,i,a,l)=>{if(!t||!o)return;const r=[];let s=0;for(const c of t){const f=this.accessors.getFlowOriginId(c),u=this.accessors.getFlowDestId(c);if((o.has(f)||o.has(u))&&this.isFlowInSelection(c,i,a)&&f!==u&&(r.push(c),s++),s>l)break}return r.reverse()}),this._getFlowMagnitudeExtent=w(this.getSortedAggregatedFilteredFlows,this.getSelectedLocationsSet,this.getLocationFilterMode,(t,o,i)=>{if(!t)return;let a;for(const l of t)if(this.accessors.getFlowOriginId(l)!==this.accessors.getFlowDestId(l)&&this.isFlowInSelection(l,o,i)){const r=this.accessors.getFlowMagnitude(l);a==null?a=[r,r]:(r<a[0]&&(a[0]=r),r>a[1]&&(a[1]=r))}return a}),this._getAdaptiveFlowMagnitudeExtent=w(this.getFlowsForFlowmapLayer,t=>{if(!t)return;const o=Dt(t,this.accessors.getFlowMagnitude);return o[0]!==void 0&&o[1]!==void 0?o:void 0}),this.getFlowMagnitudeExtent=(t,o)=>t.settings.adaptiveScalesEnabled?this._getAdaptiveFlowMagnitudeExtent(t,o):this._getFlowMagnitudeExtent(t,o),this.getLocationMaxAbsTotalGetter=w(this.getLocationTotals,t=>o=>{const i=t==null?void 0:t.get(o);if(i)return Math.max(Math.abs(i.incomingCount+i.internalCount),Math.abs(i.outgoingCount+i.internalCount))}),this.getFlowThicknessScale=w(this.getFlowMagnitudeExtent,Si),this.getCircleSizeScale=w(this.getMaxLocationCircleSize,this.getLocationTotalsEnabled,this.getLocationTotalsExtent,(t,o,i)=>{if(!o)return()=>t;if(i)return Xn().range([0,t]).domain([0,Math.max.apply(null,i.map(a=>Math.abs(a||0)))])}),this.getInCircleSizeGetter=w(this.getCircleSizeScale,this.getLocationTotals,(t,o)=>i=>{const a=o==null?void 0:o.get(i);return a&&t&&t(Math.abs(a.incomingCount+a.internalCount))||0}),this.getOutCircleSizeGetter=w(this.getCircleSizeScale,this.getLocationTotals,(t,o)=>i=>{const a=o==null?void 0:o.get(i);return a&&t&&t(Math.abs(a.outgoingCount+a.internalCount))||0}),this.getSortedLocationsForZoom=w(this.getLocationsForZoom,this.getInCircleSizeGetter,this.getOutCircleSizeGetter,(t,o,i)=>t?[...t].sort((l,r)=>{const s=this.accessors.getLocationId(l),c=this.accessors.getLocationId(r);return De(Math.max(o(s),i(s)),Math.max(o(c),i(c)))}):void 0),this.getLocationsForFlowmapLayer=w(this.getSortedLocationsForZoom,t=>t),this.getLocationsForFlowmapLayerById=w(this.getLocationsForFlowmapLayer,t=>{if(t)return t.reduce((o,i)=>(o.set(this.accessors.getLocationId(i),i),o),new Map)}),this.getLocationOrClusterByIdGetter=w(this.getClusterIndex,this.getLocationsById,(t,o)=>i=>{var a;return(a=t==null?void 0:t.getClusterById(i))!==null&&a!==void 0?a:o==null?void 0:o.get(i)}),this.getLayersData=w(this.getLocationsForFlowmapLayer,this.getFlowsForFlowmapLayer,this.getFlowmapColorsRGBA,this.getLocationsForFlowmapLayerById,this.getLocationIdsInViewport,this.getInCircleSizeGetter,this.getOutCircleSizeGetter,this.getFlowThicknessScale,this.getAnimate,this.getLocationLabelsEnabled,(t,o,i,a,l,r,s,c,f,u)=>this._prepareLayersData(t,o,i,a,l,r,s,c,f,u)),this.accessors=new Nt(e),this.setAccessors(e)}setAccessors(e){this.accessors=new Nt(e)}getAggregateAccessors(){return this.accessors}prepareLayersData(e,t){const o=this.getLocationsForFlowmapLayer(e,t)||[],i=this.getFlowsForFlowmapLayer(e,t)||[],a=this.getFlowmapColorsRGBA(e,t),l=this.getLocationsForFlowmapLayerById(e,t),r=this.getLocationIdsInViewport(e,t),s=this.getInCircleSizeGetter(e,t),c=this.getOutCircleSizeGetter(e,t),f=this.getFlowThicknessScale(e,t),u=this.getLocationLabelsEnabled(e,t);return this._prepareLayersData(o,i,a,l,r,s,c,f,e.settings.animationEnabled,u)}_prepareLayersData(e,t,o,i,a,l,r,s,c,f){e||(e=[]),t||(t=[]);const{getFlowOriginId:u,getFlowDestId:d,getFlowMagnitude:g,getLocationId:h,getLocationLon:p,getLocationLat:v,getLocationName:L}=this.accessors,I=Dt(t,x=>g(x)),A=Xo(o,I,!1),y=Float32Array.from(function*(){for(const x of e)yield p(x),yield v(x)}()),b=je(o)?o.positive.locationCircles.inner:o.locationCircles.inner,S=Uint8Array.from(function*(){for(const x of e)yield*b}()),m=Float32Array.from(function*(){for(const x of e){const _=h(x);yield a!=null&&a.has(_)?l(_):1}}()),C=Float32Array.from(function*(){for(const x of e){const _=h(x);yield a!=null&&a.has(_)?r(_):1}}()),E=Float32Array.from(function*(){for(const x of t){const _=i==null?void 0:i.get(u(x));yield _?p(_):0,yield _?v(_):0}}()),M=Float32Array.from(function*(){for(const x of t){const _=i==null?void 0:i.get(d(x));yield _?p(_):0,yield _?v(_):0}}()),F=Float32Array.from(function*(){for(const x of t)yield s&&s(g(x))||0}()),P=Float32Array.from(function*(){for(const x of t){const _=u(x),st=d(x);yield Math.max(l(_),r(_)),yield Math.max(l(st),r(st))}}()),z=Uint8Array.from(function*(){for(const x of t)yield*A(g(x))}()),N=c?Float32Array.from(function*(){for(const x of t)yield new yo.alea(`${u(x)}-${d(x)}`)()}()):void 0;return Object.assign({circleAttributes:{length:e.length,attributes:{getPosition:{value:y,size:2},getColor:{value:S,size:4},getInRadius:{value:m,size:1},getOutRadius:{value:C,size:1}}},lineAttributes:{length:t.length,attributes:Object.assign({getSourcePosition:{value:E,size:2},getTargetPosition:{value:M,size:2},getThickness:{value:F,size:1},getColor:{value:z,size:4},getEndpointOffsets:{value:P,size:2}},N?{getStaggering:{value:N,size:1}}:{})}},f?{locationLabels:e.map(L)}:void 0)}getLocationsInBbox(e,t){if(e)return this._getLocationsInBboxIndices(e,t).map(o=>e.points[o])}_getLocationsInBboxIndices(e,t){if(!e)return;const[o,i,a,l]=t,[r,s,c,f]=[Et(o),Ot(i),Et(a),Ot(l)];return e.range(Math.min(r,c),Math.min(s,f),Math.max(r,c),Math.max(s,f))}isFlowInSelection(e,t,o){const i=this.accessors.getFlowOriginId(e),a=this.accessors.getFlowDestId(e);if(t)switch(o){case et.ALL:return t.has(i)||t.has(a);case et.BETWEEN:return t.has(i)&&t.has(a);case et.INCOMING:return t.has(a);case et.OUTGOING:return t.has(i)}return!0}}function ye(n,e){if(!n)return;let t;for(const[o,{incomingCount:i,outgoingCount:a,internalCount:l}]of n.entries())if(e==null||e.has(o)){const r=Math.min(i+l,a+l,l),s=Math.max(i+l,a+l,l);t?(r<t[0]&&(t[0]=r),s>t[1]&&(t[1]=s)):t=[r,s]}return t}function Et(n){return n/360+.5}function Ot(n){const e=Math.sin(n*Math.PI/180),t=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return t<0?0:t>1?1:t}function ki(n,e){const t=Pe(n,i=>{const a=e.getFlowOriginId(i[0]),l=e.getFlowDestId(i[0]);return{aggregate:!0,origin:a,dest:l,count:i.reduce((s,c)=>{const f=e.getFlowMagnitude(c);return f&&!isNaN(f)&&isFinite(f)?s+f:s},0)}},e.getFlowOriginId,e.getFlowDestId),o=[];for(const i of t.values())for(const a of i.values())o.push(a);return o}function It(n,e){const{getInRadius:t,getOutRadius:o}=n.attributes;return Math.max(t.value[e],o.value[e])}function we(n,e){const{getPosition:t}=n.attributes;return[t.value[e*2],t.value[e*2+1]]}function Ni(n,e){const{getColor:t,getEndpointOffsets:o,getSourcePosition:i,getTargetPosition:a,getThickness:l,getStaggering:r}=n.attributes;return{length:1,attributes:Object.assign({getColor:{value:t.value.subarray(e*4,(e+1)*4),size:4},getEndpointOffsets:{value:o.value.subarray(e*2,(e+1)*2),size:2},getSourcePosition:{value:i.value.subarray(e*2,(e+1)*2),size:2},getTargetPosition:{value:a.value.subarray(e*2,(e+1)*2),size:2},getThickness:{value:l.value.subarray(e,e+1),size:1}},r?{getStaggering:{value:r.value.subarray(e,e+1),size:1}}:void 0)}}var Bt=1e-6,pt=Math.PI,be=pt/2,Ze=pt/4,Le=pt*2,Tt=180/pt,it=pt/180,se=Math.abs,Ve=Math.atan2,gt=Math.cos,ht=Math.sin,Bi=Math.sqrt;function ji(n){return n>1?be:n<-1?-be:Math.asin(n)}function mt(){}function bt(n,e){n&&xe.hasOwnProperty(n.type)&&xe[n.type](n,e)}var Ce={Feature:function(n,e){bt(n.geometry,e)},FeatureCollection:function(n,e){for(var t=n.features,o=-1,i=t.length;++o<i;)bt(t[o].geometry,e)}},xe={Sphere:function(n,e){e.sphere()},Point:function(n,e){n=n.coordinates,e.point(n[0],n[1],n[2])},MultiPoint:function(n,e){for(var t=n.coordinates,o=-1,i=t.length;++o<i;)n=t[o],e.point(n[0],n[1],n[2])},LineString:function(n,e){jt(n.coordinates,e,0)},MultiLineString:function(n,e){for(var t=n.coordinates,o=-1,i=t.length;++o<i;)jt(t[o],e,0)},Polygon:function(n,e){Fe(n.coordinates,e)},MultiPolygon:function(n,e){for(var t=n.coordinates,o=-1,i=t.length;++o<i;)Fe(t[o],e)},GeometryCollection:function(n,e){for(var t=n.geometries,o=-1,i=t.length;++o<i;)bt(t[o],e)}};function jt(n,e,t){var o=-1,i=n.length-t,a;for(e.lineStart();++o<i;)a=n[o],e.point(a[0],a[1],a[2]);e.lineEnd()}function Fe(n,e){var t=-1,o=n.length;for(e.polygonStart();++t<o;)jt(n[t],e,1);e.polygonEnd()}function Gi(n,e){n&&Ce.hasOwnProperty(n.type)?Ce[n.type](n,e):bt(n,e)}var Lt=new xt,Se=new xt,We,Ke,Gt,$t,Ut,Y={point:mt,lineStart:mt,lineEnd:mt,polygonStart:function(){Lt=new xt,Y.lineStart=$i,Y.lineEnd=Ui},polygonEnd:function(){var n=+Lt;Se.add(n<0?Le+n:n),this.lineStart=this.lineEnd=this.point=mt},sphere:function(){Se.add(Le)}};function $i(){Y.point=Hi}function Ui(){qe(We,Ke)}function Hi(n,e){Y.point=qe,We=n,Ke=e,n*=it,e*=it,Gt=n,$t=gt(e=e/2+Ze),Ut=ht(e)}function qe(n,e){n*=it,e*=it,e=e/2+Ze;var t=n-Gt,o=t>=0?1:-1,i=o*t,a=gt(e),l=ht(e),r=Ut*l,s=$t*a+r*gt(i),c=r*o*ht(i);Lt.add(Ve(c,s)),Gt=n,$t=a,Ut=l}function Yi(n){return[Ve(n[1],n[0]),ji(n[2])]}function Zi(n){var e=n[0],t=n[1],o=gt(t);return[o*gt(e),o*ht(e),ht(t)]}function _e(n,e){return[n[1]*e[2]-n[2]*e[1],n[2]*e[0]-n[0]*e[2],n[0]*e[1]-n[1]*e[0]]}function Vi(n){var e=Bi(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=e,n[1]/=e,n[2]/=e}var O,k,T,j,q,Xe,Je,ot,dt,K,Z,H={point:Ht,lineStart:Ee,lineEnd:Oe,polygonStart:function(){H.point=tn,H.lineStart=Wi,H.lineEnd=Ki,dt=new xt,Y.polygonStart()},polygonEnd:function(){Y.polygonEnd(),H.point=Ht,H.lineStart=Ee,H.lineEnd=Oe,Lt<0?(O=-(T=180),k=-(j=90)):dt>Bt?j=90:dt<-Bt&&(k=-90),Z[0]=O,Z[1]=T},sphere:function(){O=-(T=180),k=-(j=90)}};function Ht(n,e){K.push(Z=[O=n,T=n]),e<k&&(k=e),e>j&&(j=e)}function Qe(n,e){var t=Zi([n*it,e*it]);if(ot){var o=_e(ot,t),i=[o[1],-o[0],0],a=_e(i,o);Vi(a),a=Yi(a);var l=n-q,r=l>0?1:-1,s=a[0]*Tt*r,c,f=se(l)>180;f^(r*q<s&&s<r*n)?(c=a[1]*Tt,c>j&&(j=c)):(s=(s+360)%360-180,f^(r*q<s&&s<r*n)?(c=-a[1]*Tt,c<k&&(k=c)):(e<k&&(k=e),e>j&&(j=e))),f?n<q?B(O,n)>B(O,T)&&(T=n):B(n,T)>B(O,T)&&(O=n):T>=O?(n<O&&(O=n),n>T&&(T=n)):n>q?B(O,n)>B(O,T)&&(T=n):B(n,T)>B(O,T)&&(O=n)}else K.push(Z=[O=n,T=n]);e<k&&(k=e),e>j&&(j=e),ot=t,q=n}function Ee(){H.point=Qe}function Oe(){Z[0]=O,Z[1]=T,H.point=Ht,ot=null}function tn(n,e){if(ot){var t=n-q;dt.add(se(t)>180?t+(t>0?360:-360):t)}else Xe=n,Je=e;Y.point(n,e),Qe(n,e)}function Wi(){Y.lineStart()}function Ki(){tn(Xe,Je),Y.lineEnd(),se(dt)>Bt&&(O=-(T=180)),Z[0]=O,Z[1]=T,ot=null}function B(n,e){return(e-=n)<0?e+360:e}function qi(n,e){return n[0]-e[0]}function Ie(n,e){return n[0]<=n[1]?n[0]<=e&&e<=n[1]:e<n[0]||n[1]<e}function Xi(n){var e,t,o,i,a,l,r;if(j=T=-(O=k=1/0),K=[],Gi(n,H),t=K.length){for(K.sort(qi),e=1,o=K[0],a=[o];e<t;++e)i=K[e],Ie(o,i[0])||Ie(o,i[1])?(B(o[0],i[1])>B(o[0],o[1])&&(o[1]=i[1]),B(i[0],o[1])>B(o[0],o[1])&&(o[0]=i[0])):a.push(o=i);for(l=-1/0,t=a.length-1,e=0,o=a[t];e<=t;o=i,++e)i=a[e],(r=B(o[1],i[0]))>l&&(l=r,O=i[0],T=o[1])}return K=Z=null,O===1/0||k===1/0?[[NaN,NaN],[NaN,NaN]]:[[O,k],[T,j]]}function Ji(n,e,t){const{pad:o=.05,maxZoom:i=100}=t||{},a=Xi(n),[[l,r],[s,c]]=a,f=o?[[l-o*(s-l),r-o*(c-r)],[s+o*(s-l),c+o*(c-r)]]:a,[u,d]=e;return Object.assign(Object.assign({},dn({width:u,height:d,bounds:f,padding:t==null?void 0:t.padding,maxZoom:i})),{width:u,height:d,bearing:0,pitch:0})}function Qi(n,e,t,o){const i=l=>({type:"Point",coordinates:e(l)});let a;if(Array.isArray(n))a=n.map(i);else{a=[];for(const l of n)a.push(i(l))}return Ji({type:"GeometryCollection",geometries:a},t,o)}function ts(n){return n&&n.locations&&n.flows}function es(n){return n&&typeof n.setFlowmapState=="function"&&typeof n.getViewportForLocations=="function"&&typeof n.getFlowByIndex=="function"&&typeof n.getLocationById=="function"&&typeof n.getLocationByIndex=="function"&&typeof n.getLayersData=="function"}var V=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function r(f){try{c(o.next(f))}catch(u){l(u)}}function s(f){try{c(o.throw(f))}catch(u){l(u)}}function c(f){f.done?a(f.value):i(f.value).then(r,s)}c((o=o.apply(n,e||[])).next())})};class ns{constructor(e){this.selectors=new Ri(e),this.flowmapData=void 0,this.flowmapState=void 0}setAccessors(e){this.selectors.setAccessors(e)}setFlowmapData(e){this.flowmapData=e}getSelectors(){return this.selectors}getFlowmapData(){return this.flowmapData}setFlowmapState(e){return V(this,void 0,void 0,function*(){this.flowmapState=e})}getFlowmapState(){return this.flowmapState}getFlowByIndex(e){return V(this,void 0,void 0,function*(){if(!this.flowmapState||!this.flowmapData)return;const t=this.selectors.getFlowsForFlowmapLayer(this.flowmapState,this.flowmapData);return t==null?void 0:t[e]})}getLocationByIndex(e){return V(this,void 0,void 0,function*(){if(!this.flowmapState||!this.flowmapData)return;const t=this.selectors.getLocationsForFlowmapLayer(this.flowmapState,this.flowmapData);return t==null?void 0:t[e]})}getLayersData(){return V(this,void 0,void 0,function*(){if(!(!this.flowmapState||!this.flowmapData))return this.selectors.getLayersData(this.flowmapState,this.flowmapData)})}getLocationById(e){return V(this,void 0,void 0,function*(){if(!this.flowmapState||!this.flowmapData)return;const t=this.selectors.getClusterIndex(this.flowmapState,this.flowmapData);if(t){const i=t.getClusterById(e);if(i)return i}const o=this.selectors.getLocationsById(this.flowmapState,this.flowmapData);return o==null?void 0:o.get(e)})}getTotalsForLocation(e){var t;return V(this,void 0,void 0,function*(){if(!(!this.flowmapState||!this.flowmapData))return(t=this.selectors.getLocationTotals(this.flowmapState,this.flowmapData))===null||t===void 0?void 0:t.get(e)})}getViewportForLocations(e,t){var o;return V(this,void 0,void 0,function*(){if(!((o=this.flowmapData)===null||o===void 0)&&o.locations)return Qi(this.flowmapData.locations,i=>[this.selectors.accessors.getLocationLon(i),this.selectors.accessors.getLocationLat(i)],e,t)})}updateLayersData(e){return V(this,void 0,void 0,function*(){e(yield this.getLayersData())})}getClusterZoom(){return this.flowmapState&&this.flowmapData?this.selectors.getClusterZoom(this.flowmapState,this.flowmapData):void 0}getClusterIndex(){return this.flowmapState&&this.flowmapData?this.selectors.getClusterIndex(this.flowmapState,this.flowmapData):void 0}getLocationsById(){return this.flowmapState&&this.flowmapData?this.selectors.getLocationsById(this.flowmapState,this.flowmapData):void 0}getLocationTotals(){return this.flowmapState&&this.flowmapData?this.selectors.getLocationTotals(this.flowmapState,this.flowmapData):void 0}getFlowsForFlowmapLayer(){return this.flowmapState&&this.flowmapData?this.selectors.getFlowsForFlowmapLayer(this.flowmapState,this.flowmapData):void 0}}var Ct;(function(n){n.LOCATION="location",n.FLOW="flow"})(Ct||(Ct={}));var os=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function r(f){try{c(o.next(f))}catch(u){l(u)}}function s(f){try{c(o.throw(f))}catch(u){l(u)}}function c(f){f.done?a(f.value):i(f.value).then(r,s)}c((o=o.apply(n,e||[])).next())})};const is=["filter","locationTotalsEnabled","locationLabelsEnabled","adaptiveScalesEnabled","animationEnabled","clusteringEnabled","clusteringLevel","fadeEnabled","fadeOpacityEnabled","clusteringAuto","darkMode","fadeAmount","colorScheme","highlightColor","maxTopFlowsDisplayNum"];var nt;(function(n){n.LOCATION="location",n.FLOW="flow"})(nt||(nt={}));class en extends to{constructor(e){super(Object.assign(Object.assign({},e),{onHover:(t,o)=>{const i=Date.now();this.setState({highlightedObject:this._getHighlightedObject(t),lastHoverTime:i});const{onHover:a}=e;a&&this._getFlowmapLayerPickingInfo(t).then(l=>{var r,s;((s=(r=this.state)===null||r===void 0?void 0:r.lastHoverTime)!==null&&s!==void 0?s:0)<=i&&(this.setState({pickingInfo:l}),a(l,o))})},onClick:(t,o)=>{const{onClick:i}=e,a=Date.now();this.setState({lastClickTime:a}),i&&this._getFlowmapLayerPickingInfo(t).then(l=>{var r,s;((s=(r=this.state)===null||r===void 0?void 0:r.lastClickTime)!==null&&s!==void 0?s:0)<=a&&(this.setState({pickingInfo:l}),l&&i(l,o))})}}))}initializeState(){this.state={accessors:new Nt(this.props),dataProvider:this._getOrMakeDataProvider(),layersData:void 0,highlightedObject:void 0,pickingInfo:void 0,lastHoverTime:void 0,lastClickTime:void 0}}getPickingInfo({info:e}){var t,o;if(!e.object){const i=(o=(t=this.state)===null||t===void 0?void 0:t.pickingInfo)===null||o===void 0?void 0:o.object;if(i)return Object.assign(Object.assign({},e),{object:i,picked:!0})}return e}_getOrMakeDataProvider(){const{data:e,dataProvider:t}=this.props;if(es(t))return t;if(ts(e)){const o=new ns(this.props);return o.setFlowmapData(e),o}throw new Error("FlowmapLayer: data must be a FlowmapDataProvider or FlowmapData")}_updateDataProvider(){this.setState({dataProvider:this._getOrMakeDataProvider()})}shouldUpdateState(e){const{changeFlags:t}=e;return t.viewportChanged?!0:super.shouldUpdateState(e)}updateState({oldProps:e,props:t,changeFlags:o}){if(o.propsChanged,o.dataChanged&&this._updateDataProvider(),(o.viewportChanged||o.dataChanged)&&this.setState({highlightedObject:void 0}),o.viewportChanged||o.dataChanged||o.propsChanged&&is.some(i=>e[i]!==t[i])){const{dataProvider:i}=this.state||{};i&&(i.setFlowmapState(this._getFlowmapState()),i.updateLayersData(a=>{this.setState({layersData:a,highlightedObject:void 0})},o))}}_getSettingsState(){const{locationTotalsEnabled:e,locationLabelsEnabled:t,adaptiveScalesEnabled:o,animationEnabled:i,clusteringEnabled:a,clusteringLevel:l,fadeEnabled:r,fadeOpacityEnabled:s,clusteringAuto:c,darkMode:f,fadeAmount:u,colorScheme:d,highlightColor:g,maxTopFlowsDisplayNum:h}=this.props;return{locationTotalsEnabled:e,locationLabelsEnabled:t,adaptiveScalesEnabled:o,animationEnabled:i,clusteringEnabled:a,clusteringLevel:l,fadeEnabled:r,fadeOpacityEnabled:s,clusteringAuto:c,darkMode:f,fadeAmount:u,colorScheme:d,highlightColor:g,maxTopFlowsDisplayNum:h}}_getFlowmapState(){return{viewport:ss(this.context.viewport),filter:this.props.filter,settings:this._getSettingsState()}}_getFlowmapLayerPickingInfo(e){var t;return os(this,void 0,void 0,function*(){const{index:o,sourceLayer:i}=e,{dataProvider:a,accessors:l}=this.state||{};if(!a||!l)return;const r=Object.assign(Object.assign({},e),{picked:e.picked,layer:e.layer,index:e.index,x:e.x,y:e.y,coordinate:e.coordinate,event:e.event});if(i instanceof tt||i instanceof yt){const s=o===-1?void 0:yield a.getFlowByIndex(o);if(s){const c=yield a.getLocationById(l.getFlowOriginId(s)),f=yield a.getLocationById(l.getFlowDestId(s));if(c&&f)return Object.assign(Object.assign({},r),{object:{type:Ct.FLOW,flow:s,origin:c,dest:f,count:l.getFlowMagnitude(s)}})}}else if(i instanceof ut){const s=o===-1?void 0:yield a.getLocationByIndex(o);if(s){const c=l.getLocationId(s),f=l.getLocationName(s),u=yield a.getTotalsForLocation(c),{circleAttributes:d}=((t=this.state)===null||t===void 0?void 0:t.layersData)||{};if(u&&d){const g=It(d,e.index);return Object.assign(Object.assign({},r),{object:{type:Ct.LOCATION,location:s,id:c,name:f,totals:u,circleRadius:g}})}}}})}_getHighlightedObject(e){var t,o;const{index:i,sourceLayer:a}=e;if(!(i<0)){if(a instanceof tt||a instanceof yt){const{lineAttributes:l}=((t=this.state)===null||t===void 0?void 0:t.layersData)||{};if(l){let r=Ni(l,i);return this.props.fadeOpacityEnabled&&(r=Object.assign(Object.assign({},r),{attributes:Object.assign(Object.assign({},r.attributes),{getColor:Object.assign(Object.assign({},r.attributes.getColor),{value:new Uint8Array([...r.attributes.getColor.value.slice(0,3),255])})})})),{type:nt.FLOW,lineAttributes:r}}}else if(a instanceof ut){const{circleAttributes:l}=((o=this.state)===null||o===void 0?void 0:o.layersData)||{};if(l)return{type:nt.LOCATION,coords:we(l,i),radius:It(l,i)}}}}renderLayers(){var e;const t=[];if(!((e=this.state)===null||e===void 0)&&e.layersData){const{layersData:o,highlightedObject:i}=this.state,{circleAttributes:a,lineAttributes:l,locationLabels:r}=o||{};if(a&&l){const s=Ko(this._getSettingsState()),c=U(s.outlineColor||(this.props.darkMode?"#000":"#fff")),f={data:l,parameters:Object.assign(Object.assign({},this.props.parameters),{depthTest:!1})};if(this.props.animationEnabled?t.push(new yt(Object.assign({},this.getSubLayerProps(Object.assign(Object.assign({},f),{id:"animated-flow-lines",drawOutline:!1,thicknessUnit:20}))))):t.push(new tt(Object.assign({},this.getSubLayerProps(Object.assign(Object.assign({},f),{id:"flow-lines",drawOutline:!0,outlineColor:c}))))),t.push(new ut(this.getSubLayerProps({id:"circles",data:a,emptyColor:this.props.darkMode?[0,0,0,255]:[255,255,255,255],outlineEmptyMix:.4}))),i)switch(i.type){case nt.LOCATION:t.push(new eo(Object.assign({},this.getSubLayerProps({id:"location-highlight",data:[i],pickable:!1,antialiasing:!0,stroked:!0,filled:!1,lineWidthUnits:"pixels",getLineWidth:2,radiusUnits:"pixels",getRadius:u=>u.radius,getLineColor:U(this.props.highlightColor),getPosition:u=>u.coords}))));break;case nt.FLOW:t.push(new tt(Object.assign({},this.getSubLayerProps({id:"flow-highlight",data:i.lineAttributes,drawOutline:!0,pickable:!1,outlineColor:U(this.props.highlightColor),outlineThickness:1,parameters:{depthTest:!1}}))));break}}r&&t.push(new no(this.getSubLayerProps({id:"location-labels",data:r,maxWidth:1e3,pickable:!1,fontFamily:"Helvetica",getPixelOffset:(s,{index:c})=>[0,It(a,c)+5],getPosition:(s,{index:c})=>we(a,c),getText:s=>s,getSize:10,getColor:[255,255,255,255],getAngle:0,getTextAnchor:"middle",getAlignmentBaseline:"top"})))}return t}}en.defaultProps={darkMode:!0,fadeAmount:50,locationTotalsEnabled:!0,locationLabelsEnabled:!1,animationEnabled:!1,clusteringEnabled:!0,fadeEnabled:!0,fadeOpacityEnabled:!1,clusteringAuto:!0,clusteringLevel:void 0,adaptiveScalesEnabled:!0,colorScheme:"Teal",highlightColor:"orange",maxTopFlowsDisplayNum:5e3};function ss(n){const{width:e,height:t,longitude:o,latitude:i,zoom:a,pitch:l,bearing:r}=n;return{width:e,height:t,longitude:o,latitude:i,zoom:a,pitch:l,bearing:r}}function as({props:n={},viewId:e=0}){const{locations:t,flows:o,dark:i,elapsed:a,vizDetails:l}=n,[r,s]=ae.useState(ct.state.viewState),[c,f]=ae.useState({});vt[e]=()=>{s(ct.state.viewState)};function u(){console.log("click!")}function d(p){console.log(p),f(p)}function g(p){s(p),p.center=[p.longitude,p.latitude],ct.commit("setMapCamera",p)}const h=new en({data:n,id:"my-flowmap-"+e,getLocationId:p=>p.id,getLocationLat:p=>p.lat,getLocationLon:p=>p.lon,getLocationName:p=>p.id,getFlowOriginId:p=>p.o,getFlowDestId:p=>p.d,getFlowMagnitude:p=>p.v||null,adaptiveScalesEnabled:!0,animationEnabled:l.animationEnabled,clusteringEnabled:l.clustering,clusteringAuto:l.clustering,clusteringLevel:l.clusteringLevel,colorScheme:l.colorScheme,darkMode:i,drawOutline:!1,fadeEnabled:!0,fadeAmount:20,fadeOpacityEnabled:!0,locationLabelsEnabled:l.locationLabelsEnabled,locationTotalsEnabled:l.locationTotalsEnabled,onHover:d,opacity:1,outlineThickness:l.outlineThickness,pickable:!0});return re.createElement(un,{layers:[h],controller:!0,viewState:r,pickingRadius:4,getCursor:()=>"pointer",onClick:u,onViewStateChange:p=>g(p.viewState)},re.createElement(fn,{mapStyle:ct.getters.mapStyle,mapboxApiAccessToken:nn}))}const rs=on({name:"FlowMap",components:{FlowMapLayer:as,VizConfigurator:rn,ZoomButtons:cn},props:{config:Object,datamanager:{type:Object},fileSystemConfig:{type:Object,required:!0},files:{type:Array,required:!0},root:{type:String,required:!0},subfolder:{type:String,required:!0},thumbnail:Boolean,yamlConfig:String,configFromDashboard:Object},computed:{fileApi(){return new Qn(this.fileSystem,ct)},fileSystem(){const n=this.$store.state.svnProjects.filter(e=>e.slug===this.root);if(n.length===0)throw console.log("no such project"),Error;return n[0]},mapProps(){return{locations:this.centroids,flows:this.flows,dark:this.$store.state.isDarkMode,elapsed:this.elapsed,vizDetails:this.vizDetails}},urlThumbnail(){return this.thumbnailUrl}},watch:{"$store.state.viewState"(){vt[this.viewId]&&vt[this.viewId]()}},data(){return{boundaries:[],centroids:[],flows:[],viewId:Math.floor(1e12*Math.random()),statusText:"Loading...",needsInitialMapExtent:!0,myDataManager:this.datamanager||new ce(this.root,this.subfolder),thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",startTime:Date.now(),elapsed:0,animator:null,myState:{statusMessage:"",fileApi:void 0,fileSystem:void 0,subfolder:"",thumbnail:!1},vizDetails:{title:"",description:"",thumbnail:"",zoom:9,center:null,pitch:0,bearing:0,boundaries:"",boundariesJoinCol:"",boundariesLabels:"",boundariesLabel:"",dataset:"",origin:"",destination:"",flow:"",colorScheme:"Teal",highlightColor:"orange",fadeEnabled:!0,fadeAmount:50,animationEnabled:!0,clustering:!0,clusteringLevel:null,locationLabelsEnabled:!0,locationTotalsEnabled:!0,pickable:!0,opacity:null,fadeOpacityEnabled:!0,outlineThickness:0,showOnlyTopFlows:null,maxTopFlowsDisplayNum:null}}},async mounted(){try{if(this.$store.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myDataManager=this.datamanager||new ce(this.root,this.subfolder),await this.getVizDetails(),this.thumbnail){this.buildThumbnail();return}this.needsInitialMapExtent&&(this.vizDetails.center||this.vizDetails.zoom)&&(this.$store.commit("setMapCamera",{center:this.vizDetails.center,zoom:this.vizDetails.zoom||9,bearing:this.vizDetails.bearing||0,pitch:this.vizDetails.pitch||0,longitude:this.vizDetails.center?this.vizDetails.center[0]:0,latitude:this.vizDetails.center?this.vizDetails.center[1]:0}),this.needsInitialMapExtent=!1),await this.loadBoundaries(),await this.loadDataset(),this.$emit("isLoaded"),this.vizDetails=Object.assign({},this.vizDetails),this.statusText=""}catch(n){this.$emit("error","Flowmap"+n)}},beforeDestroy(){this.animator&&window.cancelAnimationFrame(this.animator),delete vt[this.viewId]},methods:{async getVizDetails(){if(this.configFromDashboard){console.log("we have a dashboard"),this.validateYAML(),this.vizDetails=Object.assign({},this.configFromDashboard);return}new RegExp(".*(yml|yaml)$").test(this.yamlConfig??"")&&(console.log("has yaml"),await this.loadStandaloneYAMLConfig())},async buildThumbnail(){if(this.myState.fileApi&&this.thumbnail&&this.vizDetails.thumbnail)try{const e=await(await this.myState.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail)).arrayBuffer(),t=oo.arrayBufferToBase64(e);t&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${t})`)}catch(n){console.error(n)}},async validateYAML(){},async loadStandaloneYAMLConfig(){if(!this.fileApi)return{};const n=this.yamlConfig??"",e=n.indexOf("/")>-1?n:this.subfolder+"/"+this.yamlConfig;try{const o=await this.fileApi.getFileText(e);this.vizDetails=Object.assign({},le.parse(o));return}catch(o){const i=""+o;i.startsWith("YAMLSemantic")&&this.$emit("error",`${e}: ${i}`),console.log(`${e} not found, trying config folders`)}const{vizes:t}=await this.fileApi.findAllYamlConfigs(this.subfolder);if(t[n])try{const o=await this.fileApi.getFileText(t[n]);this.vizDetails=Object.assign({},le.parse(o))}catch{console.error(`Also failed to load ${t[n]}`)}},async loadBoundaries(){try{if(this.vizDetails.boundaries.startsWith("http")){console.log("in http");const n=await fetch(this.vizDetails.boundaries).then(async e=>await e.json());this.boundaries=n.features}else{const n=`${this.subfolder}/${this.vizDetails.boundaries}`,e=await this.fileApi.getFileJson(`${this.subfolder}/${this.vizDetails.boundaries}`);this.boundaries=e.features}}catch(n){console.error(n);return}this.calculateCentroids(),this.setMapCenter()},calculateCentroids(){const n=this.vizDetails.boundariesLabels||this.vizDetails.boundariesLabel;for(const e of this.boundaries){const t=an(e);e.properties[n]&&(t.properties.label=e.properties[n]),t.properties.id=""+e.properties[this.vizDetails.boundariesJoinCol],this.centroids.push({id:`${t.properties.id}`,lon:t.geometry.coordinates[0],lat:t.geometry.coordinates[1]})}console.log({centroids:this.centroids})},async setMapCenter(){if(this.vizDetails.center){typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),this.$store.commit("setMapCamera",{longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],bearing:0,pitch:0,zoom:this.vizDetails.zoom||10,jump:!1});return}if(!this.centroids.length)return;let n=0,e=0,t=0;const o=this.centroids.length,i=256;for(let l=0;l<o;l+=i)e+=this.centroids[l].lon,t+=this.centroids[l].lat,n++;e=e/n,t=t/n;const a=this.$store.state.viewState;e&&t&&this.$store.commit("setMapCamera",{longitude:e,latitude:t,bearing:a.bearing,pitch:a.pitch,zoom:this.vizDetails.zoom||a.zoom,jump:!1})},async loadDataset(){try{const n=await this.myDataManager.getDataset(this.vizDetails);console.log("dataset:",n);const e=n.allRows||{};console.log("data:",e);const t=e.origin.values,o=e.destination.values,i=e.count.values;console.log("in loadDataset");const a=[];for(let l=0;l<t.length;l++)a.push({o:`${t[l]}`,d:`${o[l]}`,v:i[l]});this.flows=a}catch(n){const e=""+n;console.log(e),this.flows=[]}console.log({flows:this.flows})}}});var cs=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"flowmap",class:{"hide-thumbnail":!e.thumbnail},style:{background:e.urlThumbnail},attrs:{oncontextmenu:"return false"}},[t("div",{staticClass:"map-layout"},[e.centroids.length?t("flow-map-layer",{staticClass:"map-layer",attrs:{viewId:e.viewId,props:e.mapProps}}):e._e()],1),e.vizDetails.title&&!e.thumbnail&&!e.configFromDashboard?t("div",{staticClass:"title-panel"},[t("h3",[e._v(e._s(e.vizDetails.title))]),t("p",[e._v(e._s(e.vizDetails.description))])]):e._e(),e.thumbnail?e._e():t("zoom-buttons"),e.thumbnail?e._e():t("div",{staticClass:"bottom-panel"},[t("b-checkbox",{staticClass:"hello",model:{value:e.vizDetails.animationEnabled,callback:function(o){e.$set(e.vizDetails,"animationEnabled",o)},expression:"vizDetails.animationEnabled"}}),t("p",[e._v("Animation")]),t("b-checkbox",{staticClass:"hello",model:{value:e.vizDetails.locationLabelsEnabled,callback:function(o){e.$set(e.vizDetails,"locationLabelsEnabled",o)},expression:"vizDetails.locationLabelsEnabled"}}),t("p",[e._v("Labels")]),t("b-checkbox",{staticClass:"hello",model:{value:e.vizDetails.clustering,callback:function(o){e.$set(e.vizDetails,"clustering",o)},expression:"vizDetails.clustering"}}),t("p",[e._v("Clustering")])],1)],1)},ls=[];var us=sn(rs,cs,ls,!1,null,"60662dc6",null,null);const Bs=us.exports;export{Bs as default};
//# sourceMappingURL=Flowmap-d38b34de.js.map
