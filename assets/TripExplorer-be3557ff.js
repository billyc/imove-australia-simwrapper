import{d as b,n as _,D as T,r as z,g as m,R as S,M as A,e as p,B as k,U as x,C as D}from"./index-6ca30cbc.js";import{d as I}from"./index-184364fc.js";import{y as $}from"./index-650b7cb7.js";import{d as w}from"./index-992ee35a.js";import{O as L}from"./LineOffsetLayer-961ed66a.js";import{P as O}from"./PathOffsetLayer-ad01a140.js";import{D as P,S as R}from"./set-rtl-text-plugin-b53dbe89.js";import{C as W}from"./layer-312e45a6.js";import{H as F}from"./HTTPFileSystem-a263b5e7.js";import{V}from"./VuePlotly-34269977.js";import{Z as M}from"./ZoomButtons-88e704ed.js";import{L as j}from"./LegendStore-3aadd543.js";import"./line-layer-af1f0344.js";import"./path-layer-5677aaba.js";import"./extends-98964cd2.js";const B=b({name:"TimeSliderLinksGl",props:{useRange:Boolean,stops:{type:Array,required:!0},dropdownValue:String},data(){return{sliderValue:0}},watch:{useRange(e){e?this.sliderValue=[this.stops[0],this.stops[this.stops.length-1]]:this.sliderValue=[this.stops[0]],console.log("changed to: "+this.sliderValue)},sliderValue(e){this.$emit("change",e)}},mounted(){}});var E=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"time-slider-main-content"},[s("b-slider",{attrs:{max:t.stops.length-1,tooltip:!1},model:{value:t.sliderValue,callback:function(i){t.sliderValue=i},expression:"sliderValue"}},t._l(t.stops,function(i,c){return s("b-slider-tick",{key:c,attrs:{value:c}})}),1)],1)},N=[];var U=_(B,E,N,!1,null,"8ae40083",null,null);const H=U.exports,q={messages:{en:{selectColumn:"Data:",loading:"Loading...",bandwidths:"Widths: 1 pixel =:",timeOfDay:"",colors:"Colors"},de:{selectColumn:"Datenmengen:",loading:"Laden...",bandwidths:"Linienbreiten: 1 pixel =:",timeOfDay:"",colors:"Farben"}}},Y=b({name:"SelectorPanel",i18n:q,components:{TimeSlider:H},props:{csvData:{type:Object,required:!0},scaleWidth:{type:Number,required:!0},showDiffs:{type:Boolean,required:!0},vizDetails:{type:Object,required:!0}},data(){return{isButtonActive:!1,isColorButtonActive:!1,scaleWidthValue:"",debounceScale:{},handleTimeSliderChanged:{}}},computed:{activeColumn(){return this.csvData.activeColumn},buttonTitle(){return this.activeColumn?this.activeColumn:""+this.$i18n.t("loading")}},watch:{scaleWidth(){this.scaleWidthValue=""+this.scaleWidth},scaleWidthValue(){isNaN(parseFloat(this.scaleWidthValue))||this.debounceScale()}},methods:{getColumns(){return Object.values(this.csvData.dataTable).slice(1).filter(t=>t.name&&t.type!==T.LOOKUP).map(t=>t.name)},gotNewScale(){this.$emit("scale",parseFloat(this.scaleWidthValue))},changeTimeSlider(e){e.length&&e.length===1&&(e=e[0]),this.$emit("slider",{dataset:this.csvData,column:this.getColumns()[e]})},handleClickDropdown(){this.isButtonActive=!this.isButtonActive},handleColorRamp(e){console.log(e),this.isColorButtonActive=!1,this.$emit("colors",e)},clearDropdown(){console.log("boop"),this.isButtonActive=!1},async handleSelectColumn(e){console.log("panel: selected",e),this.isButtonActive=!1,this.$emit("column",{dataset:this.csvData,column:e})}},mounted(){this.debounceScale=w.debounce(this.gotNewScale,500),this.handleTimeSliderChanged=w.debounce(this.changeTimeSlider,250),this.scaleWidthValue=""+this.scaleWidth}});var G=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"config-panel"},[t.vizDetails.useSlider&&t.activeColumn?s("div",{staticClass:"panel-item expand"},[s("p",[s("b",[t._v(t._s(t.activeColumn))])]),s("time-slider",{staticClass:"time-slider",attrs:{useRange:!1,stops:t.getColumns(),dropdownValue:t.activeColumn},on:{change:t.handleTimeSliderChanged}})],1):t._e(),t.vizDetails.useSlider?t._e():s("div",{staticClass:"panel-item"},[s("p",[s("b",[t._v(t._s(t.$t("selectColumn")))])]),s("div",{staticClass:"dropdown is-up full-width",class:{"is-active":t.isButtonActive}},[s("div",{staticClass:"dropdown-trigger"},[s("button",{staticClass:"full-width is-warning button",class:{"is-loading":!t.activeColumn},attrs:{"aria-haspopup":"true","aria-controls":"dropdown-menu-column-selector"},on:{click:t.handleClickDropdown}},[s("b",[t._v(t._s(t.buttonTitle))]),t._m(0)])]),s("div",{staticClass:"dropdown-menu",style:{"max-height":"24rem","overflow-y":"auto",border:"1px solid #ccc"},attrs:{id:"dropdown-menu-column-selector",role:"menu"}},[s("div",{staticClass:"dropdown-content"},t._l(t.getColumns(),function(i){return s("a",{staticClass:"dropdown-item",on:{click:function(c){return t.handleSelectColumn(i)}}},[t._v(t._s(i))])}),0)])])])])},K=[function(){var e=this,t=e._self._c;return e._self._setupProxy,t("span",{staticClass:"icon is-small"},[t("i",{staticClass:"fas fa-angle-down",attrs:{"aria-hidden":"true"}})])}];var X=_(Y,G,K,!1,null,"9e971bc6",null,null);const Z=X.exports;function J({viewId:e=0,links:t={source:new Float32Array,dest:new Float32Array},colorRampType:s=-1,dark:i=!1,projection:c="",scaleWidth:n=1,mapIsIndependent:r=!1,click:h={},paths:d=[]}){const[g,u]=z.useState(m.state.viewState);p[e]=a=>{u(a||m.state.viewState)};function l(a){console.log("click!",a),a.coordinate&&(console.log(a.coordinate),h({coordinate:a.coordinate}))}function o(a){u(a),a.center=[a.longitude,a.latitude],r||m.commit("setMapCamera",a)}function C({object:a,index:f}){return null}const y=W.DEFAULT,v=new O({id:"pathLayer",data:d,getPath:a=>a.path,getColor:[0,200,128],getWidth:3,widthUnits:"pixels",widthScale:1,widthMinPixels:.5,widthMaxPixels:50,pickable:!0,coordinateSystem:y,opacity:.35,autoHighlight:!0,highlightColor:[255,0,224],offsetDirection:L.LEFT,transitions:{getColor:250,getWidth:250,getPath:0,widthScale:250},parameters:{depthTest:!1}});return S.createElement(P,{layers:[v],viewState:g,controller:!0,pickingRadius:5,getTooltip:C,getCursor:({isDragging:a,isHovering:f})=>a?"grabbing":f?"pointer":"grab",onClick:l,onViewStateChange:a=>o(a.viewState)},S.createElement(R,{mapStyle:m.getters.mapStyle,mapboxApiAccessToken:A}))}const Q=b({name:"ReliabilityExplorer",components:{SelectorPanel:Z,LinkLayer:J,ToggleButton:I.ToggleButton,VuePlotly:V,ZoomButtons:M},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},data(){return{apiKey:"",serverRetries:0,selectedPaths:[],numTrips:0,avgSpeed:0,dayOfWeek:["is-warning","is-warning","is-warning","is-warning","is-warning","",""],vehType:["is-success","",""],currentCoord:[],radius:2e-4,speedData:[],globalState:m.state,layout:{paper_bgcolor:k.dark,plot_bgcolor:k.dark,font:{family:x,color:"#cccccc"},height:300,margin:{t:8,b:0,l:0,r:0,pad:2},xaxis:{automargin:!0,autorange:!0,title:{text:"Hour",standoff:12},animate:!0},yaxis:{automargin:!0,autorange:!0,title:{text:"Speed",standoff:16},animate:!0},legend:!1},options:{displaylogo:!1,responsive:!0,modeBarButtonsToRemove:["pan2d","zoom2d","select2d","lasso2d","zoomIn2d","zoomOut2d","autoScale2d","hoverClosestCartesian","hoverCompareCartesian","resetScale2d","toggleSpikelines","resetViewMapbox"],toImageButtonOptions:{format:"png",filename:"scatter-plot",width:null,height:null}},standaloneYAMLconfig:{title:"",description:"",csvFile:"",csvBase:"",datasets:{},useSlider:!1,showDifferences:!1,shpFile:"",dbfFile:"",network:"",geojsonFile:"",projection:"",center:null,zoom:0,widthFactor:null,thumbnail:"",sum:!1,nodes:"",links:[],mapIsIndependent:!1,display:{color:{},width:{}}},YAMLrequirementsLinks:{},vizDetails:{title:"",description:"",csvFile:"",csvBase:"",datasets:{},useSlider:!1,showDifferences:!1,server:"",shpFile:"",dbfFile:"",network:"",geojsonFile:"",projection:"",center:null,zoom:0,widthFactor:null,thumbnail:"",sum:!1,nodes:"",links:[],mapIsIndependent:!1,display:{color:{},width:{}}},currentUIFilterDefinitions:{},isButtonActiveColumn:!1,linkLayerId:`linklayer-${Math.floor(1e12*Math.random())}`,scaleWidth:0,numLinks:0,showTimeRange:!1,legendStore:new j,geojsonData:{source:new Float32Array,dest:new Float32Array,linkIds:[],projection:""},fixedColors:["#4e79a7"],myState:{statusMessage:"",subfolder:"",yamlConfig:"",thumbnail:!1},isDarkMode:this.$store.state.colorScheme===D.DarkMode,isDataLoaded:!1,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",resizer:void 0}},computed:{fileApi(){return new F(this.fileSystem,m)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},urlThumbnail(){return this.thumbnailUrl},colorRampType(){var t,s;const e=(s=(t=this.vizDetails.display.color)==null?void 0:t.colorRamp)==null?void 0:s.style;return e===void 0?-1:e}},watch:{"$store.state.viewState"(){this.vizDetails.mapIsIndependent||p[this.linkLayerId]&&p[this.linkLayerId]()},"$store.state.colorScheme"(){setTimeout(()=>this.isDarkMode=this.$store.state.colorScheme===D.DarkMode,100)}},methods:{toggleDay(e){this.dayOfWeek[e]=this.dayOfWeek[e]?"":"is-warning",this.dayOfWeek=[...this.dayOfWeek]},toggleVehicle(e){this.vehType=["","",""],this.vehType[e]="is-success"},setDataIsLoaded(){this.isDataLoaded=!0},async getVizDetails(){const e=this.myState.yamlConfig,t={showDifferences:!1,datasets:{},display:{color:{},width:{}}};if(this.config){this.vizDetails=Object.assign({},t,this.config);return}(e!=null&&e.endsWith("yaml")||e!=null&&e.endsWith("yml"))&&await this.loadStandaloneYamlConfig();const s=this.vizDetails.title?this.vizDetails.title:e||"Trip Explorer";this.$emit("title",s)},async loadStandaloneYamlConfig(){try{const e=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig,t=await this.fileApi.getFileText(e);this.standaloneYAMLconfig=Object.assign({},$.parse(t)),this.setVizDetails()}catch(e){console.error("failed",""+e)}},setVizDetails(){this.vizDetails=Object.assign({},this.vizDetails,this.standaloneYAMLconfig)},async fetchWithAuthorization(e){return console.log("fetchTrips",this.serverRetries),await fetch(e,{headers:{Authorization:this.apiKey,"Access-Control-Allow-Origin":"*"}}).then(async s=>{if(console.log(1,{response:s}),s.status==200)return console.log(200),this.serverRetries=0,s.json();if(s.status==403)return console.log(403),this.serverRetries+=1,this.forceApiAuthorization(),await this.fetchWithAuthorization(e);if(this.serverRetries<5)return this.serverRetries+=1,this.myState.statusMessage=`Contacting server... (${this.serverRetries})`,await new Promise(i=>setTimeout(i,2e3)),await this.fetchWithAuthorization(e);throw Error("API ERROR: "+s.statusText)})},async handleClick(e){console.log("GOT YOU:",e),e.coordinate&&(await this.clickedCoordinate(e.coordinate),await this.runStatisticsForCoord(e.coordinate))},async runStatisticsForCoord(e){this.currentCoord=e,console.log("number of PATHS:",this.selectedPaths);const t=e[0]-this.radius,s=e[0]+this.radius,i=e[1]-this.radius,c=e[1]+this.radius,n={time:[],speeds:[]};for(const r of this.selectedPaths){const h=r.path;console.log("  number of POINTS:",h.length);let d=0;for(let l=0;l<h.length;l++){const o=h[l];o[0]>=t&&o[0]<=s&&o[1]>=i&&o[1]<=c&&(d=l)}console.log("  i:",d);try{const l=r.speeds[d],o=parseInt(r.startTime.substring(0,2));if(l==0)continue;n.time.push(o),n.speeds.push(l)}catch{console.warn("bad index")}const u=n.speeds.reduce((l,o)=>l+o)/n.speeds.length;this.avgSpeed=u}console.log(n),this.speedData=[{x:n.time,y:n.speeds,name:"Speed by Hour",mode:"markers",type:"scatter",textinfo:"label+percent",textposition:"inside",automargin:!0,showlegend:!1,marker:{size:3,color:"#ff4"}}]},async clickedCoordinate(e){const[t,s]=e;console.log({lon:t,lat:s});const i=this.vizDetails.server,c=`${i}/location?lon=${t}&lat=${s}&radius=0.0002`;console.log(c);const n=await this.fetchWithAuthorization(c);if(!n.length){this.selectedPaths=[],this.numTrips=0;return}const r=[];this.numTrips=n.length;const h=807;let d=0;for(;d<this.numTrips;){console.log("loading",d);const g=n.slice(d,d+h).map(o=>o.TripID).join(","),u=`${i}/path?trip=${g}`;console.log("path length:",u.length);const l=await this.fetchWithAuthorization(u);for(const o of l){const y=o.Path1.split(",").map(a=>a.split(" ").map(f=>parseFloat(f))),v=o.Speed_path.split(",").map(a=>parseFloat(a));r.push({path:y,speeds:v,startTime:o.start_time})}this.selectedPaths=[...r],await this.$nextTick(),d+=h}},setMapCenterFromVizDetails(){typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),this.vizDetails.zoom||(this.vizDetails.zoom=9),this.$store.commit("setMapCamera",{longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],bearing:0,pitch:0,zoom:this.vizDetails.zoom,jump:!1});const e={longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],bearing:0,pitch:0,zoom:this.vizDetails.zoom||10,jump:!1};p[this.linkLayerId]&&p[this.linkLayerId](e)},async setMapCenter(){if(this.vizDetails.center)return this.setMapCenterFromVizDetails();const e=this.geojsonData;if(!e.source.length)return;let t=0,s=0,i=0;if(this.geojsonData.projection!=="Atlantis"){const c=e.source.length/2,n=c<4096?2:1024;for(let r=0;r<c;r+=n)s+=e.source[r*2],i+=e.source[r*2+1],t++;s=s/t,i=i/t}console.log("center",s,i),this.$store.commit("setMapCamera",{longitude:s,latitude:i,bearing:0,pitch:0,zoom:8,jump:!1})},setupLogoMover(){this.resizer=new ResizeObserver(this.moveLogo);const e=document.getElementById(`container-${this.linkLayerId}`);this.resizer.observe(e)},moveLogo(){const e=document.getElementById(`container-${this.linkLayerId}`),t=e==null?void 0:e.querySelector(".mapboxgl-ctrl-bottom-left");if(t){const s=e.clientWidth>640?"280px":"36px";t.style.right=s}},async updateStatus(e){this.myState.statusMessage=e},getApiAuthorization(){console.log("GETAPI");let e=localStorage.getItem("imove-api-key");e||(e=prompt("API access key required:")),e&&(this.apiKey=e,localStorage.setItem("imove-api-key",e))},forceApiAuthorization(){localStorage.removeItem("imove-api-key"),this.getApiAuthorization()},async wakeUpServer(){try{fetch(this.vizDetails.server)}catch{}}},async mounted(){this.$store.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig??"",this.myState.subfolder=this.subfolder,await this.getVizDetails(),this.wakeUpServer(),this.setupLogoMover(),console.log("ok")},beforeDestroy(){delete p[this.linkLayerId],this.$store.commit("setFullScreen",!1)}});var tt=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"link-volume-plot",class:{"hide-thumbnail":!t.thumbnail},style:{background:t.urlThumbnail},attrs:{oncontextmenu:"return false"}},[s("div",{staticClass:"details-panel"},[s("h3",{staticClass:"center"},[t._v("RELIABILITY EXPLORER")]),s("p",{staticClass:"center"},[s("br"),t._v(t._s(t.numTrips?" ":"Select an intersection."))]),s("div",{staticClass:"statistics"},[s("h3",[t._v("Trips")]),t.numTrips?s("h4",[t._v(t._s(t.numTrips)+" trip"+t._s(t.numTrips==1?"":"s")+" found")]):s("h4",[t._v(" ")]),s("br"),s("p",[t._v("Day of Week")]),s("b-button",{staticClass:"is-small",attrs:{type:t.dayOfWeek[0]},on:{click:function(i){return t.toggleDay(0)}}},[t._v("Mo")]),s("b-button",{staticClass:"is-small",attrs:{type:t.dayOfWeek[1]},on:{click:function(i){return t.toggleDay(1)}}},[t._v("Tu")]),s("b-button",{staticClass:"is-small",attrs:{type:t.dayOfWeek[2]},on:{click:function(i){return t.toggleDay(2)}}},[t._v("We")]),s("b-button",{staticClass:"is-small",attrs:{type:t.dayOfWeek[3]},on:{click:function(i){return t.toggleDay(3)}}},[t._v("Th")]),s("b-button",{staticClass:"is-small",attrs:{type:t.dayOfWeek[4]},on:{click:function(i){return t.toggleDay(4)}}},[t._v("Fr")]),s("b-button",{staticClass:"is-small",attrs:{type:t.dayOfWeek[5]},on:{click:function(i){return t.toggleDay(5)}}},[t._v("Sa")]),s("b-button",{staticClass:"is-small",attrs:{type:t.dayOfWeek[6]},on:{click:function(i){return t.toggleDay(6)}}},[t._v("Su")]),s("br"),s("br"),s("p",[t._v("Vehicle Types")]),s("b-button",{staticClass:"is-small",attrs:{type:t.vehType[0]},on:{click:function(i){return t.toggleVehicle(0)}}},[t._v("All")]),s("b-button",{staticClass:"is-small",attrs:{type:t.vehType[1]},on:{click:function(i){return t.toggleVehicle(1)}}},[t._v("Cars")]),s("b-button",{staticClass:"is-small",attrs:{type:t.vehType[2]},on:{click:function(i){return t.toggleVehicle(2)}}},[t._v("HCV")]),s("br"),s("br")],1),s("div",{staticClass:"reliability"},[s("h3",[t._v("Reliability")]),s("p",[t._v("Speed by time of day")]),s("br"),s("p",[s("b",[t._v("Average speed: "+t._s(Math.round(10*t.avgSpeed)/10))])]),t.speedData.length?s("vue-plotly",{staticClass:"myplot",attrs:{data:t.speedData,layout:t.layout,options:t.options,id:"speed-plot"}}):t._e()],1)]),s("div",{staticClass:"plot-container",attrs:{id:`container-${t.linkLayerId}`}},[s("link-layer",{staticClass:"map-area",attrs:{viewId:t.linkLayerId,colorRampType:t.colorRampType,dark:t.isDarkMode,projection:t.vizDetails.projection,mapIsIndependent:t.vizDetails.mapIsIndependent,click:t.handleClick,paths:t.selectedPaths}}),t.thumbnail?t._e():s("zoom-buttons",{staticClass:"zoom-buttons"}),t.thumbnail?t._e():s("div",{staticClass:"bottom-panel"},[t.myState.statusMessage?s("div",{staticClass:"status-message"},[s("p",[t._v(t._s(t.myState.statusMessage))])]):t._e()])],1)])},et=[];var st=_(Q,tt,et,!1,null,"17b2c1b4",null,null);const vt=st.exports;export{vt as default};
//# sourceMappingURL=TripExplorer-be3557ff.js.map
