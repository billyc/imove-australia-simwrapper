import{b as st,R as h,r as O,g as S,e as B,M as it,d as nt,C as X,n as at}from"./index-6ca30cbc.js";import{d as rt}from"./index-184364fc.js";import{r as ot}from"./index-c6adecee.js";import{y as lt}from"./index-650b7cb7.js";import{c as ct}from"./index-734cd08e.js";import{H as ht}from"./HTTPFileSystem-a263b5e7.js";import{Z as dt}from"./ZoomButtons-88e704ed.js";import{a as pt,p as ut,f as ft,g as mt}from"./util-6eb30833.js";import{W as gt}from"./RoadNetworkLoader.worker-48aaa0eb.js";import{D as vt,S as yt}from"./set-rtl-text-plugin-b53dbe89.js";import{P as bt}from"./PathOffsetLayer-ad01a140.js";import{P as kt}from"./path-layer-5677aaba.js";import{ae as Y,af as St,_ as K}from"./layer-312e45a6.js";import{L as $t}from"./layer-extension-f4bc7f3f.js";import{A as J}from"./arc-layer-771501a9.js";import{T as Z,S as q}from"./text-layer-9c1ec202.js";import"./fxp-26b9b10f.js";import"./extends-98964cd2.js";var wt=function s(t,e){var i=/(^([+\-]?(?:0|[1-9]\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?)?$|^0x[0-9a-f]+$|\d+)/gi,n=/(^[ ]*|[ ]*$)/g,a=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,l=/^0x[0-9a-f]+$/i,u=/^0/,c=function(b){return s.insensitive&&(""+b).toLowerCase()||""+b},d=c(t).replace(n,"")||"",g=c(e).replace(n,"")||"",p=d.replace(i,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),v=g.replace(i,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),$=parseInt(d.match(l),16)||p.length!==1&&d.match(a)&&Date.parse(d),_=parseInt(g.match(l),16)||$&&g.match(a)&&Date.parse(g)||null,w,T;if(_){if($<_)return-1;if($>_)return 1}for(var y=0,L=Math.max(p.length,v.length);y<L;y++){if(w=!(p[y]||"").match(u)&&parseFloat(p[y])||p[y]||0,T=!(v[y]||"").match(u)&&parseFloat(v[y])||v[y]||0,isNaN(w)!==isNaN(T))return isNaN(w)?1:-1;if(typeof w!=typeof T&&(w+="",T+=""),w<T)return-1;if(w>T)return 1}return 0};const A=st(wt),Tt={inject:{"vs:#decl":`
attribute vec2 instanceDashArrays;
attribute float instanceDashOffsets;
varying vec2 vDashArray;
varying float vDashOffset;
`,"vs:#main-end":`
vDashArray = instanceDashArrays;
vDashOffset = instanceDashOffsets / width.x;
`,"fs:#decl":`
uniform float dashAlignMode;
uniform float capType;
uniform bool dashGapPickable;
varying vec2 vDashArray;
varying float vDashOffset;

float round(float x) {
  return floor(x + 0.5);
}
`,"fs:#main-start":`
  float solidLength = vDashArray.x;
  float gapLength = vDashArray.y;
  float unitLength = solidLength + gapLength;

  float offset;

  if (unitLength > 0.0) {
    if (dashAlignMode == 0.0) {
      offset = vDashOffset;
    } else {
      unitLength = vPathLength / round(vPathLength / unitLength);
      offset = solidLength / 2.0;
    }

    float unitOffset = mod(clamp(vPathPosition.y, 0.0, vPathLength) + offset, unitLength);

    if (gapLength > 0.0 && unitOffset > solidLength) {
      if (capType <= 0.5) {
        if (!(dashGapPickable && picking_uActive)) {
          discard;
        }
      } else {
        // caps are rounded, test the distance to solid ends
        float distToEnd = length(vec2(
          min(unitOffset - solidLength, unitLength - unitOffset),
          vPathPosition.x
        ));
        if (distToEnd > 1.0) {
          if (!(dashGapPickable && picking_uActive)) {
            discard;
          }
        }
      }
    }
  }
`}},Ct={inject:{"vs:#decl":`
attribute float instanceOffsets;
`,"vs:DECKGL_FILTER_SIZE":`
  float offsetWidth = abs(instanceOffsets * 2.0) + 1.0;
  size *= offsetWidth;
`,"vCornerOffset = offsetVec;":`
  float offsetWidth = abs(instanceOffsets * 2.0) + 1.0;
  vec2 offsetCenter = -instanceOffsets * (isCap ? perp : miterVec * miterSize) * 2.0;
  vCornerOffset = vCornerOffset * offsetWidth - offsetCenter;
`,"fs:#main-start":`
  float isInside;
  isInside = step(-1.0, vPathPosition.x) * step(vPathPosition.x, 1.0);
  if (isInside == 0.0) {
    discard;
  }
`}},xt={getDashArray:{type:"accessor",value:[0,0]},getOffset:{type:"accessor",value:0},dashJustified:!1,dashGapPickable:!1};class H extends $t{constructor({dash:t=!1,offset:e=!1,highPrecisionDash:i=!1}={}){super({dash:t||i,offset:e,highPrecisionDash:i})}isEnabled(t){return"pathTesselator"in t.state}getShaders(t){if(!t.isEnabled(this))return null;let e={};return t.opts.dash&&(e=Y(e,Tt)),t.opts.offset&&(e=Y(e,Ct)),e}initializeState(t,e){const i=this.getAttributeManager();!i||!e.isEnabled(this)||(e.opts.dash&&i.addInstanced({instanceDashArrays:{size:2,accessor:"getDashArray"}}),e.opts.highPrecisionDash&&i.addInstanced({instanceDashOffsets:{size:1,accessor:"getPath",transform:e.getDashOffsets.bind(this)}}),e.opts.offset&&i.addInstanced({instanceOffsets:{size:1,accessor:"getOffset"}}))}updateState(t,e){if(!e.isEnabled(this))return;const i={};e.opts.dash&&(i.dashAlignMode=this.props.dashJustified?1:0,i.dashGapPickable=!!this.props.dashGapPickable),this.state.model.setUniforms(i)}getDashOffsets(t){const e=[0],i=this.props.positionFormat==="XY"?2:3,n=Array.isArray(t[0]),a=n?t.length:t.length/i;let l,u;for(let c=0;c<a-1;c++)l=n?t[c]:t.slice(c*i,c*i+i),l=this.projectPosition(l),c>0&&(e[c]=e[c-1]+St(u,l)),u=l;return e}}K(H,"defaultProps",xt);K(H,"extensionName","PathStyleExtension");function _t(s){const t=s.items.map(e=>h.createElement("li",{key:e.value+e.value[0]},h.createElement("div",{style:{width:"100%",height:`${Math.max(1,3*(1*e.value-1)+3)}px`,backgroundColor:`rgb(${e.color})`}}),e.label&&h.createElement("div",{style:{marginBottom:"0.5rem"}},e.label)));return h.createElement("div",null,h.createElement("h4",{style:{textAlign:"left",fontWeight:"bold",marginBottom:"0.5rem",fontSize:"0.8rem"}},s.title),h.createElement("p",null,s.description),h.createElement("ul",{style:{listStyle:"none",padding:0,margin:0}},t))}const M={pickup:[0,150,255],delivery:[240,0,60],service:[255,64,255]};function Dt(s){const[t,e]=O.useState(S.state.viewState),[i,n]=O.useState({}),[a,l]=O.useState({type:"activity",pickups:[],deliveries:[]}),{dark:u,activeTab:c,numSelectedTours:d,shipments:g,depots:p,legs:v,settings:$,stopActivities:_,center:w,onClick:T,projection:y}=s,{simplifyTours:L,scaleFactor:b,shipmentDotsOnTourMap:R}=$;let E=b==0?1e-6:1/Math.pow(2,(100-b)/5-6);const C=[];B[s.viewId]=()=>{e(S.state.viewState)},O.useEffect(()=>{const r={},o={};g.forEach(f=>{let m=`${f.fromX}-${f.fromY}`;r[m]||(r[m]={type:"pickup",shipmentIds:[],coord:[f.fromX,f.fromY]}),r[m].shipmentIds.push(f.$id),m=`${f.toX}-${f.toY}`,o[m]||(o[m]={type:"delivery",shipmentIds:[],coord:[f.toX,f.toY]}),o[m].shipmentIds.push(f.$id)}),l({type:"activity",pickups:Object.values(r),deliveries:Object.values(o)})},[g]);function z(r){r.object?T(r.object):T(null)}function P(r){e(r),r.center=[r.longitude,r.latitude],S.commit("setMapCamera",r)}function D(r){const{object:o}=r;return o?(o==null?void 0:o.type)=="pickup"?W(r,"pickup"):(o==null?void 0:o.type)=="delivery"?W(r,"delivery"):o!=null&&o.color?Q(r):(o==null?void 0:o.type)=="depot"?null:j(r):null}function W(r,o){const{object:f,x:m,y:x}=r;return h.createElement("div",{className:"tooltip",style:{backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",opacity:.9,left:m+20,top:x+20}},h.createElement("table",{style:{maxWidth:"30rem",fontSize:"0.8rem"}},h.createElement("tbody",null,h.createElement("tr",null,h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},o,":"),h.createElement("td",{style:{paddingTop:"0.2rem"}},f.shipmentIds.join(", "))))))}function Q(r){var x,I;const{object:o,x:f,y:m}=r;return h.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:f+20,top:m-30}},h.createElement("b",null,(x=o==null?void 0:o.tour)==null?void 0:x.vehicleId),h.createElement("br",null),"Leg # ",1+(o==null?void 0:o.count)," ",h.createElement("br",null),"Shipments on board: ",(I=o==null?void 0:o.shipmentsOnBoard)==null?void 0:I.length," ",h.createElement("br",null),"Total size: ",o==null?void 0:o.totalSize)}function j(r){const{object:o,x:f,y:m}=r,x=o.visits.length,I=o.visits.reduce((k,N)=>k+N.pickup.length,0),U=o.visits.reduce((k,N)=>k+N.delivery.length,0),et=I+U,G={visits:x,pickups:I,deliveries:U},V=Object.keys(o).length*20+32;let F=m-30;return F+V>window.innerHeight&&(F=m-V),h.createElement("div",{className:"tooltip",style:{fontSize:"0.7rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:f+20,top:F}},h.createElement("table",{style:{fontSize:"0.8rem"}},h.createElement("tbody",null,Object.keys(G).map(k=>h.createElement("tr",{key:k},h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem"}},k,":"),h.createElement("td",{style:{fontWeight:"bold"}}," ",G[k]))),et==1&&Object.keys(o.details).map(k=>h.createElement("tr",{key:k},h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},k.slice(1),":"),h.createElement("td",{style:{paddingTop:"0.2rem"}},o.details[k]))))))}if(c=="tours"&&(C.push(new kt({id:"shipmentLocationDashedLine",data:_,getPath:r=>[r.ptFrom,r.ptTo],getColor:[128,128,128],getOffset:2,opacity:1,widthMinPixels:3,rounded:!0,shadowEnabled:!1,pickable:!1,autoHighlight:!1,highlightColor:[255,255,255],parameters:{depthTest:!1},getDashArray:[3,2],dashJustified:!0,extensions:[new H({dash:!0})]})),L?C.push(new J({id:"leg-arcs",data:v,getSourcePosition:r=>r.points[0],getTargetPosition:r=>r.points[r.points.length-1],getSourceColor:r=>r.color,getTargetColor:r=>r.color,getWidth:b?r=>r.totalSize/2:3,getHeight:.5,widthMinPixels:2,widthMaxPixels:200,widthUnits:"pixels",widthScale:E,opacity:.9,parameters:{depthTest:!1},updateTriggers:{getWidth:[b]},transitions:{getWidth:150},pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n})):C.push(new bt({id:"deliveryroutes",data:v,getPath:r=>r.points,getColor:r=>r.color,getWidth:b?r=>r.totalSize:3,getOffset:2,opacity:1,widthMinPixels:3,widthMaxPixels:200,widthUnits:"pixels",widthScale:E,rounded:!0,shadowEnabled:!1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n,parameters:{depthTest:!1},updateTriggers:{getWidth:[b]},transitions:{getWidth:150}})),C.push(new Z({id:"dest-labels",data:_,background:!0,backgroundPadding:d!==1?[2,1,2,1]:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:r=>{const o=r.visits.reduce((m,x)=>m+x.pickup.length,0),f=r.visits.reduce((m,x)=>m+x.delivery.length,0);return o&&f?[0,0,255]:o?M.pickup:f?M.delivery:[240,130,0]},getPosition:r=>r.midpoint,getText:r=>r.label=="Depot"?r.label:d!==1?" ":`${r.label}`,getSize:r=>r.label=="Depot"?11:d!==1?4:11,getTextAnchor:"middle",getAlignmentBaseline:"center",opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n,visible:R}))),c=="shipments"){C.push(new q({id:"deliveries",data:a.deliveries,getPosition:o=>o.coord,getColor:M.delivery,getRadius:3,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:n})),C.push(new q({id:"pickups",data:a.pickups,getPosition:o=>o.coord,getColor:M.pickup,getRadius:2,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:n}));const r=g.length>1?32:255;C.push(new J({id:"shipments",data:g,getSourcePosition:o=>[o.fromX,o.fromY],getTargetPosition:o=>[o.toX,o.toY],getSourceColor:[0,228,255,r],getTargetColor:[240,0,60,224],getWidth:b?o=>parseInt(o.$size)||1:1,widthUnits:"pixels",getHeight:.5,opacity:.9,parameters:{depthTest:!1},widthScale:E,widthMinPixels:1,widthMaxPixels:100,updateTriggers:{getWidth:[b]},transitions:{getWidth:200}}))}C.push(new Z({id:"depots",data:p,background:!0,backgroundPadding:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:[0,150,240],getPosition:r=>r.midpoint,getText:r=>"Depot",getTextAnchor:"middle",getAlignmentBaseline:"center",getSize:11,opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n}));const tt=y&&y!=="Atlantis";return h.createElement(vt,{layers:C,pickingRadius:3,controller:!0,getCursor:()=>"pointer",onClick:z,viewState:t,onViewStateChange:r=>P(r.viewState)},tt&&h.createElement(yt,{mapboxApiAccessToken:it,mapStyle:S.getters.mapStyle}),D(i))}const At={messages:{en:{carriers:"Carriers",vehicles:"VEHICLES",services:"SERVICES",shipments:"SHIPMENTS",tours:"TOURS",pickup:"Pickup",delivery:"Delivery",flatten:"Simple&nbsp;tours",shipmentDots:"Show shipments",scaleSize:"Widths",scaleFactor:"Width"},de:{carriers:"Unternehmen",vehicles:"FAHRZEUGE",services:"BETRIEBE",shipments:"LIEFERUNGEN",tours:"TOUREN",pickup:"Abholung",delivery:"Lieferung"}}};A.insensitive=!0;const Pt=nt({name:"CarrierPlugin",i18n:At,components:{LegendColors:_t,ToggleButton:rt.ToggleButton,TourViz:Dt,ZoomButtons:dt},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},data:()=>({linkLayerId:Math.floor(1e12*Math.random()),vizSettings:{simplifyTours:!1,scaleShipmentSizes:!0,shipmentDotsOnTourMap:!0,scaleFactor:0},vizDetails:{network:"",carriers:"",projection:"",title:"",description:"",thumbnail:"",center:null},myState:{statusMessage:"",isRunning:!1,subfolder:"",yamlConfig:"",thumbnail:!0,data:[]},searchTerm:"",searchEnabled:!1,globalState:S.state,isLoaded:!0,showHelp:!1,activeTab:"shipments",speedStops:[-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10],speed:1,legendBits:[],links:null,toggleTours:!0,toggleVehicles:!0,toggleShipments:!0,toggleServices:!0,detailContent:"",data:null,carriers:[],vehicles:[],shipments:[],shipmentLookup:{},services:[],stopActivities:[],tours:[],plans:[],shownShipments:[],shipmentIdsInTour:[],depots:[],shownDepots:[],shownLegs:[],selectedCarrier:"",selectedTours:[],selectedPlan:null,selectedPlanIndex:null,selectedShipment:null,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",vehicleLookup:[],vehicleLookupString:{},rgb:ct({colormap:"phase",nshades:9,format:"rba"}).map(s=>s.slice(0,3)).reverse(),dropdownIsActive:!1}),computed:{fileApi(){return new ht(this.fileSystem,S)},fileSystem(){const s=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(s.length===0)throw console.log("no such project"),Error;return s[0]},urlThumbnail(){return this.thumbnailUrl},textColor(){const s={text:"#3498db",bg:"#eeeef480"},t={text:"white",bg:"#181518aa"};return this.globalState.isDarkMode?t:s}},watch:{"$store.state.viewState"(){B[this.linkLayerId]&&B[this.linkLayerId]()},"globalState.isDarkMode"(){this.updateLegendColors()},async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()}},methods:{handleSelectShipment(s){if(this.selectedShipment===s){if(this.selectedShipment=null,this.shownShipments=[],!this.selectedTours.length){const t=this.carriers.filter(e=>e.$id==this.selectedCarrier);this.selectedCarrier="",this.handleSelectCarrier(t[0])}return}this.shownShipments=this.shipments.filter(t=>t.$id===s.$id),this.selectedShipment=s},processActivitiesInTour(s){const t=[];let e=0;const i={};let n=this.vehicles.filter(d=>d.$id===s.vehicleId)[0];const a=this.links[n.$depotLinkId];let l=[.5*(a[0]+a[2]),.5*(a[1]+a[3])],u=n.$depotLinkId;i[`L${n.$depotLinkId}`]={link:n.$depotLinkId,midpoint:l,visits:[{pickup:[],delivery:[],service:[]}],label:"",tour:s,details:{},ptFrom:[a[0],a[1]],ptTo:[a[2],a[3]]};for(const d of s.plan){if(!d.$shipmentId)continue;t.push(d.$shipmentId);const g=this.shipmentLookup[d.$shipmentId];if(!g)continue;const p=d.$type==="pickup"?g.$from:g.$to,v=[this.links[p][0],this.links[p][1]],$=[this.links[p][2],this.links[p][3]],_=[.5*(v[0]+$[0]),.5*(v[1]+$[1])],w=this.$t(d.$type),{from:T,fromX:y,fromY:L,to:b,toX:R,toY:E,id:C,...z}=g,P={id:g.$id,type:w,count:e++,link:p,midpoint:_,label:"",tour:s,details:z,ptFrom:v,ptTo:$};if(p==u)i[`L${p}`].visits[i[`L${p}`].visits.length-1][d.$type].push(P);else if(`L${p}`in i){const D={pickup:[],delivery:[],service:[]};D[d.$type].push(P),i[`L${p}`].visits.push(D)}else{const D={pickup:[],delivery:[],service:[]};D[d.$type].push(P),i[`L${p}`]={link:p,midpoint:_,label:"",tour:s,details:z,ptFrom:v,ptTo:$,visits:[D]}}u=p}const c=Object.values(i);for(let d=0;d<c.length;d++)c[d].label=`${d}`;return c[0].label="Depot",{shipmentIdsInTour:t,stopActivities:c}},setupDepots(){const s={};this.vehicles.forEach(t=>{const e=t.$depotLinkId;let i=this.links[e];i&&(s[e]||(s[e]={type:"depot",link:t.$depotLinkId,midpoint:[.5*(i[0]+i[2]),.5*(i[1]+i[3])],coords:this.links[t.$depotLinkId],vehicles:{}}),s[e].vehicles[t.$id]=t)}),this.depots=Object.values(s),this.shownDepots=this.depots.slice(0)},selectAllTours(){this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[],this.shownShipments=this.shipments.slice(0);for(const s of this.tours){s.legs.forEach((e,i)=>this.addRouteToMap(s,e,i++));const t=this.processActivitiesInTour(s);this.stopActivities=this.stopActivities.concat(t.stopActivities),this.setupDepots()}},async handleSelectTour(s){if(!s.legs.length){console.log("No Route.");for(let n=0;n<s.plan.length;n++)if(s.plan[n].$shipmentId){const a=s.plan[n].$shipmentId,l=[this.shipmentLookup[a].$from,this.shipmentLookup[a].$to];s.legs.push({links:l})}this.vizSettings.simplifyTours=!0}if(this.selectedTours.includes(s)){this.selectedTours=this.selectedTours.filter(n=>n!==s),this.shownLegs=this.shownLegs.filter(n=>n.tour!==s),this.stopActivities=this.stopActivities.filter(n=>n.tour!==s),this.selectedTours.length||this.selectAllTours();return}this.selectedTours.length||(this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[]),this.selectedTours.push(s);const{shipmentIdsInTour:t,stopActivities:e}=this.processActivitiesInTour(s);this.shipmentIdsInTour=t;let i=0;for(const n of s.legs)this.addRouteToMap(s,n,i++);this.stopActivities=this.stopActivities.concat(e)},addRouteToMap(s,t,e){const i=[[this.links[t.links[0]][0],this.links[t.links[0]][1]]];for(const n of t.links){const a=i[i.length-1],l=[this.links[n][0],this.links[n][1]];(l[0]!==a[0]||l[1]!==a[1])&&i.push(l),i.push([this.links[n][2],this.links[n][3]])}this.shownLegs=this.shownLegs.concat([{tour:s,shipmentsOnBoard:t.shipmentsOnBoard,totalSize:t.totalSize,count:e,points:i,color:this.rgb[(3+s.tourNumber)%this.rgb.length],type:"leg"}])},handleSelectCarrier(s){var i,n;if(this.dropdownIsActive=!1,!this.links)return;const t=s.$id;if(this.vehicles=[],this.shipments=[],this.services=[],this.tours=[],this.plans=[],this.shownShipments=[],this.shownDepots=[],this.selectedShipment=null,this.shipmentIdsInTour=[],this.stopActivities=[],this.shownLegs=[],this.selectedCarrier===t){this.selectedCarrier="";return}this.selectedCarrier=t;let e=s.capabilities.vehicles.vehicle||[];this.vehicles=e.sort((a,l)=>A(a,l)),this.setupDepots(),this.shipments=this.processShipments(s),(n=(i=s.services)==null?void 0:i.service)!=null&&n.length&&(this.services=s.services.service.map(a=>a.$).sort((a,l)=>A(a.$id,l.$id))),this.tours=this.processTours(s),this.shownShipments=this.shipments,this.selectAllTours()},getAllPlans(s){if(s.plan!=null){this.plans.push(s.plan),this.selectedPlan=s.plan;return}if(s.plans!=null){if(s.plans.plan.length==null){this.plans.push(s.plans.plan),this.selectedPlan=s.plans.plan;return}this.plans=s.plans.plan;for(let t=0;t<s.plans.plan.length;t++){if(s.plans.plan[t].selected=="true"){this.selectedPlan=s.plans.plan[t];break}this.selectedPlan=s.plans.plan[t]}}},processTours(s){if(this.getAllPlans(s),!this.selectPlan||!this.plans.length)return[];Array.isArray(this.selectedPlan.tour)||(this.selectedPlan.tour=[this.selectedPlan.tour]);const t=this.selectedPlan.tour.map((e,i)=>{const n=[e.act[0]],a=new Set;for(let c=1;c<e.act.length;c++)e.leg[c-1].shipmentsOnBoard=[...a],n.push(e.leg[c-1]),n.push(e.act[c]),e.act[c].$type=="pickup"&&e.act[c].$shipmentId&&a.add(e.act[c].$shipmentId),e.act[c].$type=="delivery"&&e.act[c].$shipmentId&&a.delete(e.act[c].$shipmentId);const l=e.leg.filter(c=>c.route&&c.route.length).map(c=>{const d=c.shipmentsOnBoard.map(p=>this.shipmentLookup[p]),g=d.reduce((p,v)=>p+parseFloat((v==null?void 0:v.$size)||0),0);return{shipmentsOnBoard:d,totalSize:g,links:c.route?c.route.split(" "):[]}});return{vehicleId:e.$vehicleId,tourId:e.$tourId,plan:n,legs:l,tourNumber:0}});return t.sort((e,i)=>A(e.vehicleId,i.vehicleId)),t.forEach((e,i)=>e.tourNumber=i),t},processShipments(s){var e,i;if(this.shipmentLookup={},!((i=(e=s.shipments)==null?void 0:e.shipment)!=null&&i.length))return[];const t=s.shipments.shipment.sort((n,a)=>A(n.$id,a.$id));try{for(const n of t)n.fromX=.5*(this.links[n.$from][0]+this.links[n.$from][2]),n.fromY=.5*(this.links[n.$from][1]+this.links[n.$from][3]),n.toX=.5*(this.links[n.$to][0]+this.links[n.$to][2]),n.toY=.5*(this.links[n.$to][1]+this.links[n.$to][3]),this.shipmentLookup[n.$id]=n}catch{}return t},buildRouteFromUrl(){const s=this.$route.params;if(!s.project||!s.pathMatch){console.log("I CANT EVEN: NO PROJECT/PARHMATCH");return}const t=1+s.pathMatch.lastIndexOf("/"),e=s.pathMatch.substring(0,t),i=s.pathMatch.substring(t);this.myState.subfolder=e,this.myState.yamlConfig=i},async getVizDetails(){var n,a;if(this.config){this.vizDetails=Object.assign({},this.config);return}if((n=this.yamlConfig)!=null&&n.endsWith("yaml")||(a=this.yamlConfig)!=null&&a.endsWith("yml"))try{const l=this.yamlConfig.indexOf("/")>-1?this.yamlConfig:this.subfolder+"/"+this.yamlConfig,u=await this.fileApi.getFileText(l);this.vizDetails=lt.parse(u);return}catch(l){console.log("failed");const u=l;this.fileSystem.needPassword&&u.status===401&&S.commit("requestLogin",this.fileSystem.slug);return}const s=this.myState.yamlConfig.substring(0,15+this.myState.yamlConfig.indexOf("carriers")),{files:t}=await this.fileApi.getDirectory(this.myState.subfolder);let e=this.myState.yamlConfig.replaceAll("carriers","network");if(t.indexOf(e)==-1){const l=t.filter(u=>u.indexOf("network")>-1);l.length?e=l[0]:(this.myState.statusMessage="No road network found.",e="")}this.vizDetails={network:e,carriers:this.yamlConfig,title:s,description:"",center:this.vizDetails.center,projection:"",thumbnail:""};const i="Carrier Explorer";this.$emit("title",i),this.buildThumbnail()},async setMapCenter(){let s=0,t=0,e=0;if(this.vizDetails.center)typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),t=this.vizDetails.center[0],e=this.vizDetails.center[1];else if(!this.vizDetails.center){if(this.data=Object.entries(this.links),!this.data.length)return;const i=this.data.length/2,n=4096;for(let a=0;a<i;a+=n)t+=this.data[a*2][1][0],e+=this.data[a*2+1][1][1],s++;t=t/s,e=e/s}t&&e&&this.$store.commit("setMapCamera",{longitude:t,latitude:e,zoom:9,bearing:0,pitch:0,jump:!1})},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const s=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail),t=await ot.arraybuffer(s),e=pt(t);e&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${e})`)}catch(s){console.error(s)}},handleClick(s){console.log("CLICK!",s),s||this.clickedEmptyMap(),(s==null?void 0:s.type)=="depot"&&this.clickedDepot(s),(s==null?void 0:s.type)=="leg"&&this.clickedLeg(s)},clickedDepot(s){const t=Object.values(s.vehicles).map(e=>e.$id);this.selectedTours=[],this.shownShipments=[];for(const e of this.tours)t.includes(e.vehicleId)&&(this.handleSelectTour(e),this.shipmentIdsInTour.forEach(i=>{this.shownShipments.push(this.shipmentLookup[i])}))},clickedLeg(s){s!=null&&s.tour&&this.handleSelectTour(s==null?void 0:s.tour)},clickedEmptyMap(){this.selectAllTours()},updateLegendColors(){},async loadCarriers(){const s=await this.loadFileOrGzippedFile(this.vizDetails.carriers);return s?(await ut(s,{alwaysArray:["carriers.carrier","carriers.carrier.capabilities.vehicles.vehicle","carriers.carrier.plan.tour","carriers.carrier.shipments.shipment","carriers.carrier.services.service"]})).carriers.carrier.sort((i,n)=>A(i.$id,n.$id)):[]},async loadNetwork(){if(this.myState.statusMessage="Loading network...",this.vizDetails.network.indexOf(".xml.")>-1){const s=`${this.myState.subfolder}/${this.vizDetails.network}`,t=await this.fetchNetwork(s,{});this.vizDetails.projection=""+t.projection,this.myState.statusMessage="Building network link table";const e={};return t.linkIds.forEach((i,n)=>{e[i]=[t.source[n*2],t.source[n*2+1],t.dest[n*2],t.dest[n*2+1]]}),e}else{const s=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.network);return this.vizDetails.projection="EPSG:4326",s}},async fetchNetwork(s,t){return new Promise((e,i)=>{const n=new gt;try{n.postMessage({filePath:s,fileSystem:this.fileSystem,vizDetails:t}),n.onmessage=a=>{if(a.data.promptUserForCRS){let l=prompt("Enter the coordinate reference system, e.g. EPSG:25832")||"EPSG:31468";Number.isFinite(parseInt(l))&&(l=`EPSG:${l}`),n.postMessage({crs:l});return}if(a.data.status){this.myState.statusMessage=""+a.data.status;return}n.terminate(),a.data.error&&(console.error(a.data.error),S.commit("error",a.data.error),this.myState.statusMessage=a.data.error,i(a.data.error)),e(a.data.links)}}catch(a){n.terminate(),console.error(a),i(a)}})},toggleLoaded(s){this.isLoaded=s},rotateColors(){localStorage.setItem("plugin/agent-animation/colorscheme",this.globalState.isDarkMode?X.DarkMode:X.LightMode)},async loadFileOrGzippedFile(s){let t=`${this.subfolder}/${s}`;try{if(t.indexOf("*")>-1||t.indexOf("?")>-1){const n=t.substring(1+t.lastIndexOf("/")),a=t.substring(0,t.lastIndexOf("/")),{files:l}=await this.fileApi.getDirectory(a),u=ft(l,n);if(u.length==0)throw Error(`No files matched "${n}"`);if(u.length>1)throw Error(`More than one file matched "${n}": ${u}`);t=`${a}/${u[0]}`}let i="";if(t.endsWith("xml")||t.endsWith("gz")){const a=await(await this.fileApi.getFileBlob(t)).arrayBuffer(),l=mt(a);return new TextDecoder("utf-8").decode(l)}}catch{}const e=`Error loading ${t}`;return S.commit("error",e),this.myState.statusMessage=e,""},selectDropdown(){this.dropdownIsActive=!this.dropdownIsActive},selectPlan(s){for(let t=0;t<this.plans.length;t++)this.plans[t].$selected="false";s.$selected="true",this.selectedPlanIndex=this.plans.indexOf(s),this.selectedTours=[],this.selectDropdown(),this.selectedPlan=s}},async mounted(){S.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.subfolder=this.subfolder,this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails(),!this.thumbnail&&(this.showHelp=!1,this.updateLegendColors(),this.myState.statusMessage="Loading carriers...",this.carriers=await this.loadCarriers(),await this.$nextTick(),this.links=await this.loadNetwork(),this.setMapCenter(),this.myState.statusMessage="",this.carriers.length&&this.handleSelectCarrier(this.carriers[0]),this.tours.length&&this.handleSelectTour(this.tours[0]))},beforeDestroy(){this.myState.isRunning=!1,S.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1)}});var It=function(){var t=this,e=t._self._c;return t._self._setupProxy,e("div",{staticClass:"carrier-viewer",class:{"hide-thumbnail":!t.thumbnail},style:{background:t.urlThumbnail},attrs:{oncontextmenu:"return false"}},[e("div",{staticClass:"container-1"},[e("div",{staticClass:"main-panel"},[t.thumbnail?t._e():e("tour-viz",{staticClass:"anim",attrs:{activeTab:t.activeTab,shipments:t.shownShipments,depots:t.shownDepots,legs:t.shownLegs,stopActivities:t.stopActivities,dark:t.globalState.isDarkMode,center:t.vizDetails.center,viewId:t.linkLayerId,settings:t.vizSettings,numSelectedTours:t.selectedTours.length,onClick:t.handleClick,projection:t.vizDetails.projection}}),t.thumbnail?t._e():e("ZoomButtons"),t.myState.statusMessage?e("div",{staticClass:"xmessage"},[t._v(t._s(t.myState.statusMessage))]):t._e()],1),t.thumbnail?t._e():e("div",{staticClass:"right-panel",attrs:{darkMode:!0}},[t.carriers.length?e("h3",{staticStyle:{"margin-left":"0.25rem"}},[t._v(t._s(t.$t("carriers")))]):t._e(),e("div",{staticClass:"carrier-list"},t._l(t.carriers,function(i){return e("div",{key:i.$id,staticClass:"carrier",class:{selected:i.$id===t.selectedCarrier},on:{click:function(n){return t.handleSelectCarrier(i)}}},[e("div",{staticClass:"carrier-title"},[t._v(t._s(i.$id))])])}),0),e("h4",[t._v(t._s(t.selectedCarrier||"Details"))]),t.selectedCarrier?e("b-field",{staticClass:"detail-buttons",attrs:{size:"is-small"}},[e("b-radio-button",{attrs:{"native-value":"shipments",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("shipments")))])]),e("b-radio-button",{attrs:{"native-value":"tours",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("tours")))])]),e("b-radio-button",{attrs:{"native-value":"vehicles",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("vehicles")))])]),t.services.length?e("b-radio-button",{attrs:{"native-value":"services",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("services")))])]):t._e()],1):t._e(),e("div",{staticClass:"detail-area"},[t.activeTab=="shipments"?e("div",{staticClass:"shipments"},[e("span",[t._v(t._s(t.$t("shipments"))+": "+t._s(t.shipments.length))]),t._l(t.shipments,function(i,n){return e("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour",class:{selected:i==t.selectedShipment,"shipment-in-tour":t.shipmentIdsInTour.includes(i.$id)},on:{click:function(a){return t.handleSelectShipment(i)}}},[t._v(t._s(`${i.$id}: ${i.$from}-${i.$to}`))])})],2):t._e(),t.activeTab=="tours"?e("div",{staticClass:"tours"},[this.plans.length>1?e("div",{staticClass:"dropdown",class:{"is-active":t.dropdownIsActive},staticStyle:{width:"100%"}},[e("div",{staticClass:"dropdown-trigger",on:{click:function(i){return t.selectDropdown()}}},[e("button",[e("span",[t._v("Plan "+t._s(t.selectedPlanIndex+1))]),t._m(0)])]),e("div",{staticClass:"dropdown-menu"},[e("div",{staticClass:"dropdown-content"},t._l(this.plans,function(i,n){return e("a",{staticClass:"dropdown-item",class:{"is-active":i.$selected=="true"},on:{click:function(a){return t.selectPlan(i)}}},[t._v("Plan "+t._s(n+1))])}),0)])]):t._e(),e("span",[t._v(t._s(t.$t("tours"))+": "+t._s(t.tours.length))]),t._l(t.tours,function(i,n){return e("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour",class:{selected:t.selectedTours.includes(i)},on:{click:function(a){return t.handleSelectTour(i)}}},[i.tourId?e("div",[t._v(t._s(i.tourId)+": "+t._s(`${i.vehicleId}`))]):e("div",[t._v(t._s(`${i.vehicleId}`))])])})],2):t._e(),t.activeTab=="vehicles"?e("div",{staticClass:"vehicles"},[e("span",[t._v(t._s(t.$t("vehicles"))+": "+t._s(t.vehicles.length))]),t._l(t.vehicles,function(i,n){return e("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour"},[t._v(t._s(i.$id))])})],2):t._e(),t.activeTab=="services"?e("div",{staticClass:"services"},[e("span",[t._v(t._s(t.$t("services"))+": "+t._s(t.services.length))]),t._l(t.services,function(i,n){return e("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour"},[t._v(t._s(`${i.$id}`))])})],2):t._e()]),e("div",{staticClass:"switchbox"},[e("div",{staticClass:"switches"},[e("p",[t._v(t._s(t.$t("scaleSize")))]),e("b-slider",{staticClass:"slider",attrs:{tooltip:!1,type:"is-link",size:"is-small"},model:{value:t.vizSettings.scaleFactor,callback:function(i){t.$set(t.vizSettings,"scaleFactor",i)},expression:"vizSettings.scaleFactor"}})],1),e("div",{staticClass:"switches"},[e("b-switch",{model:{value:t.vizSettings.shipmentDotsOnTourMap,callback:function(i){t.$set(t.vizSettings,"shipmentDotsOnTourMap",i)},expression:"vizSettings.shipmentDotsOnTourMap"}},[e("span",{domProps:{innerHTML:t._s(t.$t("shipmentDots"))}})]),e("b-switch",{model:{value:t.vizSettings.simplifyTours,callback:function(i){t.$set(t.vizSettings,"simplifyTours",i)},expression:"vizSettings.simplifyTours"}},[e("span",{domProps:{innerHTML:t._s(t.$t("flatten"))}})])],1)])],1)])])},Lt=[function(){var s=this,t=s._self._c;return s._self._setupProxy,t("span",{staticClass:"icon is-small"},[t("i",{staticClass:"fas fa-angle-down"})])}];var Et=at(Pt,It,Lt,!1,null,"cd1ff18d",null,null);const Qt=Et.exports;export{Qt as default};
//# sourceMappingURL=CarrierViewer-c62e05b3.js.map
