import{d as x,g as y,U as D,B as v,n as d}from"./index-0a2cd937.js";import{y as z}from"./index-da0a180b.js";import{V as O}from"./VuePlotly-5c981ebe.js";import{H as _}from"./HTTPFileSystem-11bb8165.js";import{D as b}from"./DashboardDataManager-c75a1cc2.js";import{c as j}from"./ColorsAndWidths-e353667b.js";import{m as E}from"./util-cf17ce82.js";import"./DataFetcher.worker-c87933e8.js";import"./RoadNetworkLoader.worker-48aaa0eb.js";import"./group-f6e6d4c5.js";import"./index-f6506551.js";import"./cubehelix-658aafe4.js";import"./rainbow-b588906e.js";import"./threshold-6ccfe732.js";import"./fxp-26b9b10f.js";const C={messages:{en:{total:"total",showChanges:"Only show changes"},de:{total:"Insgesamt",showChanges:"Nur Ã„nderungen zeigen"}}},w=x({name:"PlotlyPlugin",components:{VuePlotly:O},i18n:C,props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},config:{type:Object},datamanager:{type:Object},resize:Object,thumbnail:Boolean,yamlConfig:String},data(){return{globalState:y.state,vizDetails:{title:"",description:""},loadingText:"",jsonChart:{},id:`plotly-id-${Math.floor(1e12*Math.random())}`,traces:[],prevWidth:-1,prevHeight:-1,myDataManager:this.datamanager||new b(this.root,this.subfolder),layout:{margin:{t:8,b:0,l:50,r:0,pad:2},font:{color:"#444444",family:D},xaxis:{automargin:!0,autorange:!0,range:[0,100],title:{text:"",standoff:12},animate:!0},yaxis:{automargin:!0,autorange:!0,range:[0,100],title:{text:"",standoff:16},animate:!0,rangemode:"tozero"},yaxis2:{automargin:!0,autorange:!0,range:[0,100],title:{text:"",standoff:16},animate:!0,rangemode:"tozero"},legend:{orientation:"v",x:1,y:1}},options:{displaylogo:!1,responsive:!0,modeBarButtonsToRemove:["pan2d","zoom2d","select2d","lasso2d","zoomIn2d","zoomOut2d","autoScale2d","hoverClosestCartesian","hoverCompareCartesian","resetScale2d","toggleSpikelines","resetViewMapbox"],toImageButtonOptions:{format:"png",filename:"chart",width:null,height:null}},minXValue:Number.POSITIVE_INFINITY,minYValue:Number.POSITIVE_INFINITY,maxXValue:Number.NEGATIVE_INFINITY,maxYValue:Number.NEGATIVE_INFINITY}},computed:{fileApi(){return new _(this.fileSystem,y)},fileSystem(){const t=this.$store.state.svnProjects.filter(e=>e.slug===this.root);if(t.length===0)throw console.log("no such project"),Error;return t[0]}},watch:{"globalState.resizeEvents"(){this.changeDimensions({})},resize(t){this.changeDimensions(t)},"globalState.isDarkMode"(){this.updateTheme()}},async mounted(){if(this.updateTheme(),await this.getVizDetails(),!this.thumbnail){try{this.vizDetails.datasets&&await this.prepareData(),this.vizDetails.traces&&(this.traces=this.vizDetails.traces),this.vizDetails.layout&&this.mergeLayouts(),this.vizDetails.fixedRatio&&(this.vizDetails.layout.xaxis=Object.assign(this.vizDetails.layout.xaxis,{constrain:"domain"}),this.vizDetails.layout.yaxis=Object.assign(this.vizDetails.layout.yaxis,{constrain:"domain",scaleanchor:"x",scaleration:1})),this.vizDetails.dropdownMenu&&(this.vizDetails.interactive="dropdown"),this.vizDetails.interactive&&this.createMenus(this.vizDetails.interactive),this.vizDetails.interactive&&this.config.interactive==="slider"&&this.setFixedAxis()}catch(t){const e=t;console.error({e}),this.loadingText=""+e}this.updateTheme(),window.addEventListener("resize",this.changeDimensions),this.layout.margin={r:0,t:8,b:0,l:50,pad:2}}},beforeDestroy(){window.removeEventListener("resize",this.changeDimensions)},methods:{setFixedAxis(){for(let t=0;t<this.traces.length;t++){const e=Math.min(...this.traces[t].y),s=Math.max(...this.traces[t].y),a=Math.min(...this.traces[t].x),n=Math.max(...this.traces[t].x);n>=this.maxXValue&&(this.maxXValue=n),s>=this.maxYValue&&(this.maxYValue=s),e<=this.minYValue&&(this.minYValue=e),a<=this.minXValue&&(this.minXValue=a)}this.layout.xaxis.range=[this.minXValue,this.maxXValue],this.layout.yaxis.range=[this.minYValue,this.maxYValue],this.layout.xaxis.autorange=!1,this.layout.yaxis.autorange=!1},changeDimensions(t){t!=null&&t.height&&(t!=null&&t.width)&&(t.height!==this.prevHeight||t.width!==this.prevWidth)&&(this.prevHeight=t.height,this.prevWidth=t.width,this.layout=Object.assign({},this.layout,t))},mergeLayouts(){const t={...this.vizDetails.layout};t.margin=this.layout.margin,t.font=this.layout.font,t.legend=this.layout.legend,delete t.height,delete t.width,t.xaxis?(t.xaxis.automargin=!0,t.xaxis.autorange=!0,t.xaxis.animate=!0,t.xaxis.title||(t.xaxis.title=this.layout.xaxis.title)):t.xaxis=this.layout.xaxis,t.yaxis?(t.yaxis.automargin=!0,t.yaxis.autorange=!0,t.yaxis.animate=!0,t.yaxis.rangemode||(t.yaxis.rangemode="tozero"),t.yaxis.title||(t.yaxis.title=this.layout.yaxis.title)):t.yaxis=this.layout.yaxis,t.yaxis2?(t.yaxis2.automargin=!0,t.yaxis2.autorange=!0,t.yaxis2.animate=!0,t.yaxis2.rangemode||(t.yaxis2.rangemode="tozero"),t.yaxis2.title||(t.yaxis2.title=this.layout.yaxis2.title)):t.yaxis2=this.layout.yaxis2,this.layout=t},createMenus(t){if(t=="none")return;const e=[],s={},a=Object.values(this.traces).length;Object.values(this.traces).forEach((i,l)=>{"original_name"in i&&(i.name=i.original_name),i.group_name in s||(s[i.group_name]=[]),s[i.group_name].push(l),i.visible=!1}),Object.entries(s).forEach(i=>{const[l,c]=i,h=new Array(a);h.fill(!1);for(const o of c)h[o]=!0;e.push({method:"update",args:[{visible:h}],label:l})});const n=Object.values(s)[0];for(const i of n)this.traces[i].visible=!0;const r=this.layout;if(t=="dropdown"){const i=[{buttons:e,y:1,yanchor:"top"}];r.updatemenus=i}else if(t=="slider"){const i=[{pad:{t:10},currentvalue:{visible:!1,xanchor:"left",prefix:""},steps:e}];r.sliders=i}},updateTheme(){const t={paper_bgcolor:v[this.globalState.colorScheme],plot_bgcolor:v[this.globalState.colorScheme],font:{color:this.globalState.isDarkMode?"#cccccc":"#444444"}};this.layout=Object.assign({},this.layout,t)},async getVizDetails(){if(this.config){this.vizDetails=JSON.parse(JSON.stringify(this.config)),this.$emit("title",this.vizDetails.title||"Chart"),this.vizDetails.traces&&(this.traces=this.vizDetails.traces);return}this.loadingText="Loading config...";const t=this.yamlConfig??"",e=t.indexOf("/")>-1?t:this.subfolder+"/"+t,s=await this.fileApi.getFileText(e),a=z.parse(s);this.vizDetails=a,this.vizDetails.title||(this.vizDetails.title="Chart"),this.$emit("title",this.vizDetails.title)},async prepareData(){await Promise.all(Object.entries(this.vizDetails.datasets).map(a=>{let[n,r]=a;return typeof r=="string"&&(r={file:r}),this.loadDataset(n,r)})),this.vizDetails.mergeDatasets&&Object.values(this.vizDetails.datasets).length>1&&(this.vizDetails.datasets={dataset:{name:"dataset",file:"none",data:this.mergeDatasets(Object.values(this.vizDetails.datasets))}});const t=Object.values(this.vizDetails.datasets),e=[],s=this.getColors(this.vizDetails,this.vizDetails.traces.length);this.vizDetails.traces.forEach((a,n)=>{let r=!1;t.forEach(i=>{var c;const l="$"+i.name;if((c=a.name)!=null&&c.startsWith(l)){const h=a.name.replace(l+".",""),o=this.groupDataTable(i.data,h),u=Object.keys(o).length,m=this.getColors(a,u);Object.keys(o).forEach((f,p)=>{const g=JSON.parse(JSON.stringify(a));g.name=f,g.group_name=f,this.recursiveCheckForTemplate(o[f],g,l),m&&("marker"in a||(g.marker={}),g.marker.color=m[p]),e.push(g)}),r=!0}else this.recursiveCheckForTemplate(i.data,a,l)}),r||(s&&("marker"in a||(a.marker={}),a.marker.color=s[n]),e.push(a))}),this.vizDetails.traces=e},async loadDataset(t,e){this.loadingText="Loading datasets...";const s=await this.myDataManager.getDataset({dataset:e.file},{highPrecision:!0});return e.data=s.allRows,e.name=t,this.vizDetails.datasets[t]=e,this.transformData(e),e},getColors(t,e){if("colorRamp"in t){const s=typeof t.colorRamp=="string"?{ramp:t.colorRamp}:t.colorRamp;return j(s,e>=2?e:2)}return null},transformData(t){"pivot"in t&&this.pivot(t.name,t.data,t.pivot.exclude,t.pivot.valuesTo,t.pivot.namesTo),"aggregate"in t&&this.aggregateColumns(t.data,t.aggregate.groupBy,t.aggregate.target),"constant"in t&&Object.entries(t.constant).forEach(e=>{const[s,a]=e,n=new Array(Object.values(t.data)[0].values.length);n.fill(a),t.data[s]={name:s,values:n,type:1}})},countOccurrences(t){let e={};return t.forEach(s=>{e[s]=e[s]?e[s]+1:1}),e},groupDataTable(t,e){let s={},a=t[e],n=this.countOccurrences(a.values);Object.entries(n).forEach(l=>{const[c,h]=l;let o={};Object.entries(t).forEach(u=>{const[m,f]=u;o[m]={...f};let p=Object.getPrototypeOf(f.values).constructor;o[m].values=new p(h)}),s[c]=o});for(var r=0;r<t[e].values.length;r++){var i=t[e].values[r];let l=s[i],c=l[e].values.length-n[i]--;Object.entries(t).forEach(h=>{const[o,u]=h;l[o].values[c]=u.values[r]})}return s},aggregateColumns(t,e,s){const a={},n=t[Object.keys(t)[0]].values.length;for(let i=0;i<n;i++){const l=e.reduce((c,h)=>c+=t[h].values[i],"");l in a?a[l][s]+=t[s].values[i]:(a[l]=Object.fromEntries(e.map(c=>[c,t[c].values[i]])),a[l][s]=t[s].values[i])}Object.keys(t).forEach(i=>{e.indexOf(i)==-1&&i!=s&&delete t[i]});const r=Object.fromEntries([...e,s].map(i=>[i,[]]));Object.values(a).forEach(i=>{Object.entries(i).forEach(l=>{r[l[0]].push(l[1])})}),Object.entries(r).forEach(i=>{t[i[0]].values=i[1]})},pivot(t,e,s,a,n){const r=Object.keys(e).filter(o=>s.indexOf(o)==-1);s.forEach(o=>{o in e||this.$emit("error",`Pivot column ${o} not in ${t}`)});const i=Object.fromEntries(s.map(o=>[o,[]])),l=[],c=[],h=e[Object.keys(e)[0]].values.length;for(let o=0;o<h;o++)r.forEach(u=>{s.forEach(m=>i[m].push(e[m].values[o])),c.push(u),l.push(e[u].values[o])});s.forEach(o=>{e[o].values=i[o]}),e[a]={name:a,values:l},e[n]={name:n,values:c}},mergeDatasets(t){const e={},s=t[0].data;return Object.keys(s).forEach(a=>{const n=t.map(i=>(a in i.data||this.$emit("error",`Merged dataset ${i.name} does not contain column ${a}`),i.data[a].values));let r;s[a].values instanceof Float32Array||s[a].values instanceof Float64Array?r=E(n):r=n.flat(),e[a]={name:a,type:s[a].type,values:r}}),e},recursiveCheckForTemplate(t,e,s){Object.entries(e).forEach(a=>{const[n,r]=a;if(typeof r=="string"){if(r.includes(s)){const i=r.substring(r.indexOf(".")+1);i in t?this.vizDetails.multiIndex&&i in this.vizDetails.multiIndex?e[n]=[t[i].values,t[this.vizDetails.multiIndex[i]].values]:e[n]=t[i].values:this.$emit("error",`Column "${i}" not in ${Object.keys(t)}`)}}else Array.isArray(r)?typeof r[0]=="object"&&r.forEach(i=>this.recursiveCheckForTemplate(t,i,s)):typeof r=="object"&&this.recursiveCheckForTemplate(t,r,s)})}}});var S=function(){var e=this,s=e._self._c;return e._self._setupProxy,s("div",{staticClass:"mycomponent",class:{"is-thumbnail":e.thumbnail}},[s("VuePlotly",{staticClass:"myplot",attrs:{data:e.traces,layout:e.layout,options:e.options,id:e.id}})],1)},I=[];var k=d(w,S,I,!1,null,"a8ae7f3c",null,null);const V=k.exports,M=x({name:"PlotlyDiagramPanel",components:{PlotlyDiagram:V},data:()=>({resizeEvent:{}}),props:{fileSystemConfig:{type:Object,required:!0},subfolder:{type:String,required:!0},config:{type:Object,required:!0},cardId:String},mounted(){this.$emit("isLoaded"),this.$emit("dimension-resizer",{id:this.cardId,resizer:this.changeDimensions})},methods:{changeDimensions(t){this.resizeEvent=t}}});var $=function(){var e=this,s=e._self._c;return e._self._setupProxy,s("plotly-diagram",{staticClass:"plotly-panel",attrs:{root:e.fileSystemConfig.slug,subfolder:e.subfolder,config:e.config,thumbnail:!1,resize:e.resizeEvent},on:{error:function(a){return e.$emit("error",a)}}})},A=[];var P=d(M,$,A,!1,null,"65382c66",null,null);const Q=P.exports;export{Q as default};
//# sourceMappingURL=plotly-ec67bc87.js.map
