{"version":3,"file":"TopSheet-3c264e81.js","sources":["../../src/components/TopSheet/TopSheet.vue"],"sourcesContent":["<template lang=\"pug\">\n.topsheet.curate-content\n  h3.curate-heading(v-if=\"title\")  {{ title }}\n\n  .output-table(v-if=\"entries.length\")\n    .row(v-for=\"row,i in entries\" :key=\"'entry'+i\")\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\n      b-input.b-input-tight.cell.top-value(\n        v-model=\"row.value\"\n        :style=\"row.style\"\n        @input=\"boxChanged\"\n      )\n\n  .output-table(v-if=\"table.length\" style=\"margin-top: 1rem\")\n    .row(v-for=\"row,i in table\" :key=\"'row'+i\")\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\n      .cell.top-value(:style=\"row.style\") {{ formattedValue(row.value) }}\n\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport type { PropType } from 'vue'\n\nimport { FileSystemConfig, YamlConfigs } from '@/Globals'\n\nimport TopSheetWorker from './TopSheetWorker.worker.ts?worker'\nimport globalStore from '@/store'\n\nexport type TableRow = {\n  title: string\n  value: any\n  style?: any\n}\n\nexport default defineComponent({\n  name: 'TopSheet',\n  props: {\n    fileSystemConfig: { type: Object as PropType<FileSystemConfig>, required: true },\n    subfolder: { type: String, required: true },\n    files: { type: Array as PropType<string[]>, required: true },\n    yaml: { type: String, required: true },\n    allConfigFiles: { type: Object as PropType<YamlConfigs>, required: true },\n    cardId: String,\n  },\n  data: () => {\n    return {\n      globalState: globalStore.state,\n      solverThread: null as any,\n      table: [] as TableRow[],\n      entries: [] as { key: string; title: string; value: any }[],\n      title: '',\n    }\n  },\n  mounted() {\n    if (this.files.length) this.runTopSheet()\n  },\n\n  beforeDestroy() {\n    try {\n      if (this.solverThread) {\n        this.solverThread.terminate()\n        this.solverThread = null\n      }\n    } catch (e) {\n      console.warn(e)\n    }\n  },\n  watch: {\n    'globalState.locale'() {\n      if (this.solverThread) {\n        this.solverThread.postMessage({\n          command: 'updateCalculations',\n          entries: this.entries,\n          locale: this.globalState.locale,\n        })\n      }\n    },\n  },\n  methods: {\n    formattedValue(value: any) {\n      if (!isNaN(value)) return value.toLocaleString([this.$store.state.locale, 'en'])\n      if (value === undefined) return '-?-'\n      return value\n    },\n\n    async boxChanged() {\n      console.log('changed!')\n      if (this.solverThread) {\n        this.solverThread.postMessage({\n          command: 'updateCalculations',\n          entries: this.entries,\n          locale: this.globalState.locale,\n        })\n      }\n    },\n\n    async runTopSheet() {\n      if (!this.files.length) return\n\n      try {\n        if (!this.solverThread) {\n          console.log('spawning topsheet thread')\n          this.solverThread = new TopSheetWorker()\n          this.solverThread.onmessage = (message: MessageEvent) => {\n            this.processWorkerMessage(message)\n          }\n        }\n\n        this.solverThread.postMessage({\n          command: 'runTopSheet',\n          fileSystemConfig: this.fileSystemConfig,\n          subfolder: this.subfolder,\n          files: this.files,\n          yaml: this.yaml,\n          locale: this.$store.state.locale,\n          allConfigFiles: this.allConfigFiles,\n        })\n      } catch (e) {\n        const message = '' + e\n        console.log(message)\n        this.table = []\n        // this.table = [{ title: message, value: '', style: { backgroundColor: 'yellow' } }]\n      }\n    },\n\n    processWorkerMessage(message: MessageEvent) {\n      const data = message.data\n      switch (data.response) {\n        case 'title':\n          if (this.cardId) this.$emit('titles', data.title)\n          else this.title = data.title\n          break\n        case 'entries':\n          this.entries = data.entryFields\n          break\n        case 'results':\n          this.table = data.results\n          this.$emit('isLoaded')\n          break\n        case 'error':\n          this.$emit('error', `${this.yaml}: ${data.message}`)\n          this.$emit('isLoaded')\n          break\n        default:\n          // shouldn't be here\n          this.$emit('isLoaded')\n          console.error(data)\n      }\n    },\n  },\n})\n</script>\n\n<style scoped lang=\"scss\">\n@import '@/styles.scss';\n\nh3.curate-heading {\n  font-size: 1.6rem;\n  font-weight: bold;\n  color: var(--textFancy);\n  padding-top: 0.5rem;\n  margin-top: 0rem;\n  margin-bottom: 0.5rem;\n  border-bottom: 1px dotted var(--textFancy);\n}\n\n.curate-content {\n  padding: 1rem 0rem;\n  margin: 0rem 0rem;\n}\n\n.output-table {\n  width: 100%;\n  display: table;\n}\n\n.row {\n  display: table-row;\n}\n\n.cell {\n  padding-right: 1rem;\n  display: table-cell;\n  font-size: 1.1rem;\n  line-height: 1.2rem;\n  padding-bottom: 0.4rem;\n}\n\n// .top-label {\n// }\n\n.top-value {\n  text-align: right;\n  font-weight: bold;\n  // word-break: break-all;\n}\n</style>\n"],"names":["_sfc_main","defineComponent","globalStore","e","value","TopSheetWorker","message","data"],"mappings":"6HAmCA,MAAAA,EAAAC,EAAA,CACA,KAAA,WACA,MAAA,CACA,iBAAA,CAAA,KAAA,OAAA,SAAA,EAAA,EACA,UAAA,CAAA,KAAA,OAAA,SAAA,EAAA,EACA,MAAA,CAAA,KAAA,MAAA,SAAA,EAAA,EACA,KAAA,CAAA,KAAA,OAAA,SAAA,EAAA,EACA,eAAA,CAAA,KAAA,OAAA,SAAA,EAAA,EACA,OAAA,MACA,EACA,KAAA,KACA,CACA,YAAAC,EAAA,MACA,aAAA,KACA,MAAA,CAAA,EACA,QAAA,CAAA,EACA,MAAA,EAAA,GAGA,SAAA,CACA,KAAA,MAAA,QAAA,KAAA,YAAA,CACA,EAEA,eAAA,CACA,GAAA,CACA,KAAA,eACA,KAAA,aAAA,YACA,KAAA,aAAA,YAEAC,EAAA,CACA,QAAA,KAAAA,CAAA,CACA,CACA,EACA,MAAA,CACA,sBAAA,CACA,KAAA,cACA,KAAA,aAAA,YAAA,CACA,QAAA,qBACA,QAAA,KAAA,QACA,OAAA,KAAA,YAAA,MAAA,CACA,CAEA,CACA,EACA,QAAA,CACA,eAAAC,EAAA,CACA,OAAA,MAAAA,CAAA,EACAA,IAAA,OAAA,MACAA,EAFAA,EAAA,eAAA,CAAA,KAAA,OAAA,MAAA,OAAA,IAAA,CAAA,CAGA,EAEA,MAAA,YAAA,CACA,QAAA,IAAA,UAAA,EACA,KAAA,cACA,KAAA,aAAA,YAAA,CACA,QAAA,qBACA,QAAA,KAAA,QACA,OAAA,KAAA,YAAA,MAAA,CACA,CAEA,EAEA,MAAA,aAAA,CACA,GAAA,KAAA,MAAA,OAEA,GAAA,CACA,KAAA,eACA,QAAA,IAAA,0BAAA,EACA,KAAA,aAAA,IAAAC,EACA,KAAA,aAAA,UAAAC,GAAA,CACA,KAAA,qBAAAA,CAAA,CAAA,GAIA,KAAA,aAAA,YAAA,CACA,QAAA,cACA,iBAAA,KAAA,iBACA,UAAA,KAAA,UACA,MAAA,KAAA,MACA,KAAA,KAAA,KACA,OAAA,KAAA,OAAA,MAAA,OACA,eAAA,KAAA,cAAA,CACA,QACAH,EAAA,CACA,MAAAG,EAAA,GAAAH,EACA,QAAA,IAAAG,CAAA,EACA,KAAA,MAAA,EAEA,CACA,EAEA,qBAAAA,EAAA,CACA,MAAAC,EAAAD,EAAA,KACA,OAAAC,EAAA,SAAA,CACA,IAAA,QACA,KAAA,OAAA,KAAA,MAAA,SAAAA,EAAA,KAAA,EACA,KAAA,MAAAA,EAAA,MACA,MACA,IAAA,UACA,KAAA,QAAAA,EAAA,YACA,MACA,IAAA,UACA,KAAA,MAAAA,EAAA,QACA,KAAA,MAAA,UAAA,EACA,MACA,IAAA,QACA,KAAA,MAAA,QAAA,GAAA,KAAA,IAAA,KAAAA,EAAA,OAAA,EAAA,EACA,KAAA,MAAA,UAAA,EACA,MACA,QAEA,KAAA,MAAA,UAAA,EACA,QAAA,MAAAA,CAAA,CACA,CACA,CACA,CACA,CAAA"}